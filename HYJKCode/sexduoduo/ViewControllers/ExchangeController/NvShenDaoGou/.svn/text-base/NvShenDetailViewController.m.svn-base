//
//  NvShenDetailViewController.m
//  sexduoduo
//
//  Created by dsz on 15-2-9.
//  Copyright (c) 2015年 dbCode. All rights reserved.
//

#import "NvShenDetailViewController.h"


//
//  BBSDetailViewController.m
//  sexduoduo
//
//  Created by Showm on 14-8-8.
//  Copyright (c) 2014年 dbCode. All rights reserved.
//

#import "BBSDetailCellViewController.h"
#import "LoginViewController.h"
#import "MJPhotoBrowser.h"
#import "MJPhoto.h"

#import "UMSocial.h"
#import "KWPopoverView.h"
#import "DetailNavRightPopView.h"

#import "MJRefresh.h"
@interface NvShenDetailViewController ()<UITextFieldDelegate,UIAlertViewDelegate,UIActionSheetDelegate,UMSocialUIDelegate,DetailNavRightViewDelegate,UIGestureRecognizerDelegate>
{
    UIView *headView;
    int imageIndex;
    CGFloat headViewHeight_y;
    
    UIImageView *toolBar;
    UITextField *textInput;
    
    NSMutableArray *imageArr;
    
    
    UIActionSheet * shareSheet;
    UIActionSheet * juBaoSheet;
    
    BOOL isDesc;
    BOOL isHaveNextPage;
    BOOL isHaveNextPagePingJia;
    
    CGFloat firstBegin_Y;//图文混排的第一个lab 或imageView的位置
    
    BOOL isShowNvShenProductPingLun;//是否显示商品评价功能
    
    
    NSInteger buttonClicked;//判断选中
    UIButton *dayBtn,*weekBtn;
    UIView *threeBtnBgView;
    UIImageView  *selectedView;//下划线
    float Begin_width_x,Begin_width_y,btnWidth;//按钮位置需要
    CGRect selectedViewFrame1,selectedViewFrame2;
    
    
    int currentCommentPage;//
}
@end

@implementation NvShenDetailViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
        [self judgeUmengOnline];
        
        //女神导购商品的 评价 功能
        buttonClicked=2;//初始化选中第二个按钮
    }
    return self;
}
-(void)judgeUmengOnline
{
    isShowNvShenProductPingLun=YES;
    NSString* isShow2 = [MobClick getConfigParams:@"is_ShowNvShenProductPingLun"];
    if (isShow2 && [isShow2 isEqualToString:@"NO"]) {
        isShowNvShenProductPingLun=NO;
    }
}

- (void)dealloc
{
    
}


- (void)viewDidLoad
{
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    [self setTopNavView];
    
    
    pageIndex=1;
    isDesc = NO;
    
    //    [self initBBSTableView];
    
    //    [self initToolBar];
    NSLog(@"详情%@",self.detailDic);
    
    
    //noNetworkView 1
    self.noNetworkView =(NoNetworkView *)[[[NSBundle mainBundle] loadNibNamed:@"NoNetworkView" owner:self options:nil] lastObject];
    self.noNetworkView.delegate=self;
    self.noNetworkView.frame = CGRectMake(0, STAR_Y, SCREEN_WIDTH,SCREEN_HEIGHT);
    [self.view addSubview:self.noNetworkView];
    
    
    
    //下载内容
    self.bbsDataArr=[[NSMutableArray alloc]init];//源数据
    self.contentLabAndImageArr=[[NSMutableArray alloc]init];//lab 和 imageView的存储数组
    self.recommendArray =[[NSMutableArray alloc]init];//推荐的商品
    
    [self requestBBSData];
    
    
    self.promptLab = [[UILabel alloc] initWithFrame:CGRectMake(0, STAR_Y, SCREEN_WIDTH, 35)];
    self.promptLab.backgroundColor = [UIColor blackColor];
    self.promptLab.alpha = 0.0;
    self.promptLab.font = [UIFont systemFontOfSize:14.0];
    self.promptLab.textColor = [UIColor whiteColor];
    self.promptLab.textAlignment = NSTextAlignmentCenter;
    
    
    
}

-(void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    
    //    [self requestBBSData];
}

-(void)viewDidDisappear:(BOOL)animated
{
    [super viewDidDisappear:animated];
    
    //1.
    [opration cancel];
    opration =nil;
    
    //2.
    //2.取消图文详情的下载
    
    for (int i=0; i<self.contentLabAndImageArr.count; i++) {
        if ([self.contentLabAndImageArr[i] isKindOfClass:[QzImageView class]]) {
            QzImageView *imageView=self.contentLabAndImageArr[i];
            [imageView qzCancelCurrentImageLoad];
        }
    }

}

//顶部NavView
-(void)setTopNavView
{
    int imgY = -20;
    if (IOS7_OR_LATER) {
        imgY = 0;
    }
    
    TopNavView *navView=[[TopNavView alloc] initWithFrame:CGRectMake(0, imgY,SCREEN_WIDTH, 64)];
    [self.view addSubview:navView];
    
    [navView addLeftBtnTarget:self action:@selector(toBackView) forControlEvents:UIControlEventTouchUpInside];
    
    [navView setTitleStr:@"帖子详情"];
    
    UIButton *rightBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    rightBtn.frame = CGRectMake(SCREEN_WIDTH - 52, 20 , 44, 44);
    [rightBtn addTarget:self action:@selector(replyBBSAction:) forControlEvents:UIControlEventTouchUpInside];
    [navView addSubview:rightBtn];
    
    
    UIImageView *rightBtnImg = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0 , 20, 20)];
    [rightBtnImg setImage:[UIImage imageNamed:@"BBS_navRight.png"]];
    rightBtnImg.backgroundColor = [UIColor clearColor];
    rightBtnImg.center=CGPointMake(22, 22);
    [rightBtn addSubview:rightBtnImg];
}






#pragma mark 分享
-(void)shareAction:(id)sender
{
    NSLog(@"分享");
    
    NSArray *nameStrArr=@[@"微信好友",@"微信朋友圈"];
    //自定义列表
    shareSheet = [[UIActionSheet alloc] initWithTitle:@"分享" delegate:self cancelButtonTitle:nil destructiveButtonTitle:nil otherButtonTitles:nil];
    for (int i=0; i<nameStrArr.count; i++) {
        [shareSheet addButtonWithTitle:nameStrArr[i]];
    }
    [shareSheet addButtonWithTitle:@"取消"];//默认的如果写在cancelbtn上 位置就变为0了
    shareSheet.cancelButtonIndex = shareSheet.numberOfButtons - 1;
    shareSheet.delegate = self;
    [shareSheet showInView:self.view];
}

- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (actionSheet==shareSheet) {
        if (buttonIndex + 1 >= actionSheet.numberOfButtons ) {
            return;
        }
        
        [ShareFunction showHUDWithText:@"请骚等..."];
        NSMutableDictionary *dic=[[NSMutableDictionary alloc] init];
        
        [dic setObject:self.topicId forKey:@"topicId"];
        
        [[MKHttpExchangeDemo shareMyInstance] requestBBSAppTopicShareWithDic:dic completionHandler:^(id responseObject) {
            NSLog(@"分享链接%@",responseObject);
            
            
            NSDictionary *responseDic=responseObject;
            
            if ([responseDic[@"success"] intValue]==1) {
                //分享编辑页面的接口,snsName可以换成你想要的任意平台，例如UMShareToSina,UMShareToWechatTimeline
                NSArray *snsNameArr=@[UMShareToWechatSession,UMShareToWechatTimeline];
                NSLog(@"buttonindex=%d",(int)buttonIndex);
                if (buttonIndex==0) {
                    snsNameArr=@[UMShareToWechatSession];
                }else if(buttonIndex==1)
                {
                    snsNameArr=@[UMShareToWechatTimeline];
                }
                //                NSString *snsName=snsNameArr[buttonIndex];
                
                NSString *shareUrl =responseDic[@"datasource"];
                NSString *shareText = self.detailDic[@"title"]  ;
                UIImage *shareImage = [UIImage imageNamed:@"Icon60"];
                //                UMSocialUrlResource *urlResource = [[UMSocialUrlResource alloc] initWithSnsResourceType:UMSocialUrlResourceTypeImage url:@"http://www.baidu.com/img/bdlogo.gif"];
                
                appType=WECHAT_RET;
                
                
                
                if(buttonIndex==0)
                {
                    [UMSocialData defaultData].extConfig.wechatSessionData.url = shareUrl;
                    [UMSocialData defaultData].extConfig.wechatSessionData.title = @"性多多泡吧";
                    [[UMSocialDataService defaultDataService]  postSNSWithTypes:snsNameArr content:shareText image:shareImage location:nil urlResource:nil presentedController:self completion:^(UMSocialResponseEntity *response){
                        if (response.responseCode == UMSResponseCodeSuccess) {
                            NSLog(@"分享成功！");
                        }
                    }];
                }else{
                    [UMSocialData defaultData].extConfig.wechatTimelineData.url = shareUrl;
                    
                    //朋友圈只显示titile
                    [UMSocialData defaultData].extConfig.wechatTimelineData.title = shareText;
                    
                    [[UMSocialDataService defaultDataService]  postSNSWithTypes:snsNameArr content:shareText image:shareImage location:nil urlResource:nil presentedController:self completion:^(UMSocialResponseEntity *response){
                        if (response.responseCode == UMSResponseCodeSuccess) {
                            NSLog(@"分享成功！");
                        }
                    }];
                    
                }
                
            }
            [ShareFunction hiddenHUD];
        } errorHandler:^(NSError *error) {
            NSLog(@"获取分享链接失败");
            [ShareFunction hiddenHUD];
        }];
        
        
        
        
        
        
        
    }else if(actionSheet == juBaoSheet)
    {
        NSLog(@"点击举报按钮=%d",(int)buttonIndex);
        if (buttonIndex>=0 && buttonIndex<=4) {
            NSArray *arr=@[@"广告", @"色情",@"骚扰",@"泄露隐私",@"其他"];
            NSMutableDictionary *dic=[[NSMutableDictionary alloc] init];
            
            [dic setObject:self.detailDic[@"id"] forKey:@"postId"];
            [dic setObject:arr[buttonIndex] forKey:@"reason"];
            [dic setObject:LUNTANUSERID forKey:@"userId"];
            
            [[MKHttpExchangeDemo shareMyInstance] requestBBSAppReportWithDic:dic completionHandler:^(id responseObject) {
                NSDictionary *dic=responseObject;
                NSLog(@"举报%@--%@",dic,dic[@"message"]);
                
                
                self.promptLab.text=dic[@"message"];
                [self showPromptLab];
            } errorHandler:^(NSError *error) {
                NSLog(@"举报失败");
            }];
        }
        
    }
    
}
//可选的回掉方法
-(void)didFinishGetUMSocialDataInViewController:(UMSocialResponseEntity *)response
{
    //根据`responseCode`得到发送结果,如果分享成功
    if(response.responseCode == UMSResponseCodeSuccess)
    {
        //得到分享到的微博平台名
        NSLog(@"share to sns name is %@",[[response.data allKeys] objectAtIndex:0]);
    }
}

//返回
-(void)toBackView
{
    [self.navigationController popViewControllerAnimated:YES];
    
}

//收藏 帖子
-(void)replyBBSAction:(UIButton *)sender
{
   
    DetailNavRightPopView *topAlert=[[[NSBundle mainBundle] loadNibNamed:@"DetailNavRightPopView" owner:self options:nil] lastObject];
    topAlert.topAlertViewDelegate=self;
    topAlert.frame=CGRectMake(SCREEN_WIDTH-120, STAR_Y, 110, 145);
    
    [KWPopoverView showPopoverAtPoint:sender.center inView:self.view withContentView:topAlert andRejectTouchBackOrNO:NO];
    
  
    
    
}

-(void)detailNavRightViewButtonClick:(NSInteger)index
{
    if (index==0) {// 分享
        
        NSLog(@"倒序查看");
        
        isDesc = !isDesc;
        [self requestBBSData];
        
        
    }else if (index==1)//分享
    {
        
        NSLog(@"分享");
     
        
        [self shareAction:nil];
    }else if(index == 2)//举报
    {
        NSLog(@"举报");
        
        if (ISLOGIN) {
            juBaoSheet = [[UIActionSheet alloc]
                          initWithTitle:@"请选择举报理由"
                          delegate:self
                          cancelButtonTitle:@"取消"
                          destructiveButtonTitle:nil
                          otherButtonTitles: @"广告", @"色情",@"骚扰",@"泄露隐私",@"其他",nil];
            
            [juBaoSheet showInView:self.view];
        }else{
            UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
            alert.tag=111;
            [alert show];
            
            return;
        }
    }else{//收藏
        
        NSLog(@"收藏");
        if (ISLOGIN) {
            
            NSMutableDictionary *dic=[[NSMutableDictionary alloc]init];
            [dic setObject:LUNTANUSERID forKey:@"userId"];
            [dic setObject:self.topicId forKey:@"topicId"];
            
            if(!collectBtn.selected)
            {
                [[MKHttpExchangeDemo shareMyInstance] requestBBSCollectWithDic:dic completionHandler:^(id responseObject) {
                    
                    NSDictionary *responseDic = responseObject;
                    NSLog(@"--<>>%@--%@",responseDic,[responseDic objectForKey:@"message"]);
                    
                    self.promptLab.text=responseDic[@"message"];
                    [self showPromptLab ];
                    
                    if ([responseDic[@"success"] boolValue]) {
                        
                    }
                    
                    collectBtn.selected=YES;
                } errorHandler:^(NSError *error) {
                    self.promptLab.text=@"收藏失败";
                    [self showPromptLab ];
                }];
            }else
            {
            
                [[MKHttpExchangeDemo shareMyInstance] requestBBSCancleCollectListWithDic:dic completionHandler:^(id responseObject) {
                    
                    NSDictionary *responseDic = responseObject;
                    NSLog(@"--<>>%@--%@",responseDic,[responseDic objectForKey:@"message"]);
                    
                    self.promptLab.text=responseDic[@"message"];
                    [self showPromptLab ];
                    
                    if ([responseDic[@"success"] boolValue]) {
                        
                    }
                    
                    collectBtn.selected=NO;
                } errorHandler:^(NSError *error) {
                    self.promptLab.text=@"取消收藏失败";
                    [self showPromptLab ];
                }];
            }
            
            
        
            
            
            
        }else
        {
            UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
            alert.tag=111;
            [alert show];
            
            return;
            
        }
    }
}

-(void)initToolBar
{
    //输入框
    //底框
    toolBar=[[UIImageView alloc]initWithFrame:CGRectMake(0, SCREEN_HEIGHT-40-OFFSET_Y, SCREEN_WIDTH, 40)];
    [toolBar setImage:[UIImage imageNamed:@"feedBack_InputBg"]];
    toolBar.userInteractionEnabled=YES;
    [self.view addSubview:toolBar];
    
    UIImageView *putInView=[[UIImageView alloc]initWithFrame:CGRectMake(14, 0, 243, 40)];
    //    putInView.image=[UIImage imageNamed:@"feedBack_Input"];
    [toolBar addSubview:putInView];
    
    textInput=[[UITextField alloc]initWithFrame:putInView.frame];
    textInput.delegate=self;
    //    textInput.backgroundColor=[UIColor colorWithWhite:0.5 alpha:0.5];
    textInput.font=[UIFont fontWithName:k_Font size:12.5];
    [toolBar addSubview:textInput];
    
    UIButton *sendBtn=[UIButton buttonWithType:0];
    sendBtn.frame=CGRectMake(SCREEN_WIDTH-50, 0, 50, 40);
    //    [sendBtn setImage:[UIImage imageNamed:@"feedBack_Send"] forState:UIControlStateNormal];
    [sendBtn addTarget:self action:@selector(sendBtnClick:) forControlEvents:UIControlEventTouchUpInside];
    [toolBar addSubview:sendBtn];
    
    //一个监听键盘高度改变的通知事件
    
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillShow:) name:UIKeyboardWillChangeFrameNotification object:nil];
    
    
    //添加手势事件
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(tap)];
    tap.numberOfTapsRequired = 1;
    tap.delegate=self;
    [self.view addGestureRecognizer:tap];
}
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (alertView.tag==111) {
        if (buttonIndex==1) {
            [PublicMethod gotoLoginWithVC:self];

        }
    }
}
-(void)sendBtnClick:(id)sender{
    
    if (!ISLOGIN) {//未登录
        UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
        alert.tag=111;
        [alert show];
        
        return;
    }
    
    
    
    if ([textInput.text length]>0) {
        [textInput resignFirstResponder];
        [ShareFunction showHUD];
        
        NSMutableDictionary *tempDic=[[NSMutableDictionary alloc]init];
        [tempDic setObject:[NSString stringWithFormat:@""] forKey:@"title"];
        
        NSString *contentStr=[NSString stringWithFormat:@"%@",textInput.text];
        
        if (self.forumId) {
            //转gbk
            //        NSString *dataGBK = [contentStr stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
            [tempDic setObject:contentStr forKey:@"content"];
            NSLog(@"self.detailDic=%@",self.detailDic);
            [tempDic setObject:self.forumId forKey:@"forumId"];
            [tempDic setObject:self.topicId forKey:@"topicId"];
            [tempDic setObject:self.detailDic[@"postTypeId"]  forKey:@"postTypeId"];
            [tempDic setObject:LUNTANUSERID forKey:@"userId"];
            
            NSLog(@"发送评论=%@",tempDic);
            [[MKHttpExchangeDemo shareMyInstance] postReplyExchangeInfoWithDic:tempDic completionHandler:^(id responseObject) {
                NSDictionary *responseDic=responseObject;
                NSLog(@"回复--%@   --》%@",responseDic,responseDic[@"message"]);
                
                if ([responseDic[@"success"] intValue]==1) {
                    //                    [ShareFunction showAlertWithText:@"评论成功"];
                    NSDictionary *dic=[responseDic[@"datasource"] lastObject];
                    
                    NSString *text1=nil;
                    NSString *text2=nil;
                    NSString *text3=nil;
                    text1=responseDic[@"message"];
                    if([dic[@"replyPoint"] intValue]>0)
                    {
                        text2=[NSString stringWithFormat:@"经验+%@",dic[@"replyPoint"]];
                    }
                    
                    if([dic[@"replyPrestige"] intValue]>0)
                    {
                        text2=[NSString stringWithFormat:@"积分+%@",dic[@"replyPrestige"]];
                    }
                    
                    [ShareFunction hiddenHUD];
                    [ShareFunction showToastWithText1:text1 andText2:text2 andText3:text3 inSuperview:self.view.window];
                    textInput.text=@"";
                }else{
                    [ShareFunction hiddenHUD];
                    [ShareFunction showAlertWithText:responseDic[@"message"]];
                    textInput.text=@"";
                    
                }
                
                
                //重新请求
                [self requestBBSData ];
            } errorHandler:^(NSError *error) {
                
            }];
        }
        
        
    }else{
        //        UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您未输入信息" delegate:nil cancelButtonTitle:@"确定" otherButtonTitles: nil];
        //        [alert show];
    }
    
}
#pragma mark - 手势

-(BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldReceiveTouch:(UITouch *)touch
{
    if (textInput.editing) {
        return YES;
    }
    
    return NO;
}

-(void)tap
{
    [textInput resignFirstResponder];
}

#pragma mark - 监听键盘高度改变事件
- (void)keyboardWillShow:(NSNotification *)notification {
    
    NSDictionary *userInfo = [notification userInfo];
    
    NSValue* aValue = [userInfo objectForKey:UIKeyboardFrameEndUserInfoKey];
    
    CGRect keyboardRect = [aValue CGRectValue];
    
    //改变位置
    if (textInput.isFirstResponder && keyboardRect.origin.y<SCREEN_HEIGHT) {
        
        CGRect inputViewFrame = toolBar.frame;
        inputViewFrame.origin.y = SCREEN_HEIGHT-40-keyboardRect.size.height-OFFSET_Y;
        
        [UIView animateWithDuration:0.25 animations:^{
            toolBar.frame = inputViewFrame;
        }completion:^(BOOL finished){}];
        
        
    }
}


- (void)textFieldDidBeginEditing:(UITextField *)textField
{
    CGRect inputViewFrame = toolBar.frame;
    inputViewFrame.origin.y -= 216;
    [UIView animateWithDuration:0.3 animations:^{
        toolBar.frame = inputViewFrame;
    }completion:^(BOOL finished){}];
}
-(void)textFieldDidEndEditing:(UITextField *)textField{
    [UIView animateWithDuration:0.25 animations:^{
        toolBar.frame=CGRectMake(0, SCREEN_HEIGHT-40-OFFSET_Y, SCREEN_WIDTH, 40);
    }completion:^(BOOL finished){}];
    
}

-(BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string
{
    NSLog(@"string=%@",string);
    return YES;
}
#pragma mark

-(void)collectGoodsAction
{
    [self detailNavRightViewButtonClick:3];
}


-(void)initBBSTableView
{
    if(self.bbsDetailTableView)
        self.bbsDetailTableView=nil;
    
    self.bbsDetailTableView = [[UITableView alloc] initWithFrame:CGRectMake(0, STAR_Y,SCREEN_WIDTH, SCREEN_HEIGHT- 64-40)];
    self.bbsDetailTableView.dataSource = self;
    self.bbsDetailTableView.delegate = self;
    if (IOS7_OR_LATER) {
        [self.bbsDetailTableView setSeparatorInset:UIEdgeInsetsZero];
    }
    self.bbsDetailTableView.backgroundColor = [UIColor clearColor];
    self.bbsDetailTableView.separatorStyle=UITableViewCellSeparatorStyleNone;
    [self.view addSubview:self.bbsDetailTableView];
    

    //head 该贴详情
    CGFloat begin_y=0;
    
    
    //head 存放楼主的帖子内容
    headView=[[UIView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 100)];
    headView.backgroundColor=[UIColor whiteColor];
    
    
    self.nvShenBigImageView=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_WIDTH)];
    self.nvShenBigImageView.backgroundColor=LIGHT_GRAY_COLOR;
    [self.nvShenBigImageView sd_setImageWithURL: [PublicMethod bbsImgURlAndroidWithStr:self.detailDic[@"guideImg"]] placeholderImage:nil];
    [headView addSubview:self.nvShenBigImageView];
    
    
    collectBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    collectBtn.frame = CGRectMake(SCREEN_WIDTH-QZMake(40)  -5, SCREEN_WIDTH-QZMake(40) -5, 44, 44);
    [collectBtn setImage:[UIImage imageNamed:@"collect_nor.png"] forState:UIControlStateNormal];
    [collectBtn setImage:[UIImage imageNamed:@"collect_pre.png"] forState:UIControlStateSelected];
    [collectBtn addTarget:self action:@selector(collectGoodsAction) forControlEvents:UIControlEventTouchUpInside];
    [headView addSubview:collectBtn];
    
    if ([self.detailDic[@"isCollect"] isEqualToString:@"1"]) {
        collectBtn.selected=YES;
    }else collectBtn.selected=NO;
    
    
    begin_y +=SCREEN_WIDTH;
    
    //头像
    UIImageView *headerView1=[[UIImageView alloc]initWithFrame:CGRectMake(15, begin_y-22.5, 45, 45)];
    headerView1.image=[UIImage imageNamed:@"morentouxiangMan.png"];
    headerView1.layer.cornerRadius=headerView1.frame.size.height/2.;
    headerView1.layer.masksToBounds = YES;
    headerView1.userInteractionEnabled=YES;
    headerView1.layer.borderColor=WHITE_COLOR.CGColor;
    headerView1.layer.borderWidth=4;
    [headerView1 addGestureRecognizer:[[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(headViewTap:)]];
    [headView addSubview:headerView1];
    
    
    
    UILabel *nameLab=[[UILabel alloc]initWithFrame:CGRectMake(60+5,begin_y -17.5, 300, 20)];
    nameLab.backgroundColor=[UIColor clearColor];
    NSString *nameStr=@"***";
    if (self.detailDic[@"nickname"] && ![self.detailDic[@"nickname"] isKindOfClass:[NSNull class]] ) {
        nameStr=self.detailDic[@"nickname"];
    }
    
    if ([self.detailDic[@"isShowName"] isEqualToString:@"1"]) {
        nameStr = @"匿名";
    }
    nameLab.text=nameStr;
    nameLab.font=[UIFont systemFontOfSize:15];
    nameLab.textColor=[UIColor whiteColor];
    [headView addSubview:nameLab];
    

    
    UIImage *headImage=nil;
    if (![self.detailDic[@"sex"] isKindOfClass:[NSNull class]]) {
        if ([self.detailDic[@"sex"] isEqualToString:@"0"]) {
           
            headImage=UIImageByName(@"morentouxiangWoman.png");
        }else{
          
            headImage=UIImageByName(@"morentouxiangMan.png");
        }
    }else headImage=UIImageByName(@"morentouxiangMan.png");
    headerView1.image=headImage;
    
    // 链接地址 的头像
    [headerView1 sd_setImageWithURL:[NSURL URLWithString:self.detailDic[@"headImage"]] placeholderImage:headImage];
    
  
    
    // 计算名称长度
    CGSize nameLabelsize = [nameStr sizeWithFont:[UIFont systemFontOfSize:16] constrainedToSize:CGSizeMake(210,21) lineBreakMode:NSLineBreakByCharWrapping];
  
    
    
    // 积分等级
    UIImageView *bbsdengji=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"BBS_dengji_1.png"]];
    bbsdengji.frame=CGRectMake(CGRectGetMinX(nameLab.frame)+nameLabelsize.width, CGRectGetMinY(nameLab.frame), 25*3/4., 20*3/4.);
    [headView addSubview:bbsdengji];
    
    
    if (self.detailDic[@"groupId"]) {
        NSString *imageName=[NSString stringWithFormat:@"BBS_dengji_%@",self.detailDic[@"groupId"]];
        bbsdengji.image=UIImageByName(imageName);
    }
    
    
    
    // 三围 体重 身高
    UILabel *subLab=[[UILabel alloc]initWithFrame:CGRectMake(60+5, begin_y , 300, 20)];
    subLab.backgroundColor=[UIColor clearColor];
    subLab.text=[NSString stringWithFormat:@"三围:%@  |  体重:%@  |  身高:%@",self.detailDic[@"measurements"],self.detailDic[@"weight"],self.detailDic[@"height"]];
    subLab.font=[UIFont systemFontOfSize:12];
    subLab.textColor=[UIColor lightGrayColor];
    [headView addSubview:subLab];
    
    begin_y +=20+10;
    
    
    // 标题
    UILabel *titleLab=[[UILabel alloc]initWithFrame:CGRectMake(15,begin_y, SCREEN_WIDTH-30, 20)];
    titleLab.backgroundColor=[UIColor clearColor];
    titleLab.textColor=[UIColor colorWithRed:0 green:0 blue:0 alpha:0.9];
    titleLab.font=[UIFont systemFontOfSize:17];
    titleLab.text=self.detailDic[@"title"];
    titleLab.numberOfLines=0;
    [headView addSubview:titleLab];
    
    
    
    //调整标题的高度
    CGSize titleLabsize = [titleLab.text sizeWithFont:titleLab.font constrainedToSize:CGSizeMake(SCREEN_WIDTH-30,2000) lineBreakMode:NSLineBreakByCharWrapping];
    CGRect titleLabFrame=titleLab.frame;
    titleLab.frame=CGRectMake(titleLabFrame.origin.x, titleLabFrame.origin.y, SCREEN_WIDTH-30, titleLabsize.height);
    
    
    
    begin_y=CGRectGetMaxY(titleLab.frame)+15;
    
    firstBegin_Y=begin_y;
    
    NSArray *contentArr=self.detailDic[@"contentArr"];
    
    BOOL firstImage=YES;
    int firstIndex=0;
    
    for (int i=0; i<contentArr.count; i++) {
        
        // 文本
        if ([contentArr[i][@"type"] isEqualToString:@"text"]) {
            
            NSString *contentString=contentArr[i][@"content"];
            
            // 内容
            UILabel *contentLab=[[UILabel alloc]initWithFrame:CGRectMake(15, begin_y, SCREEN_WIDTH-30, 20)];
            contentLab.backgroundColor=[UIColor clearColor];
            contentLab.textColor=[UIColor colorWithRed:0 green:0 blue:0 alpha:0.7];
            contentLab.font=[UIFont systemFontOfSize:15];
            contentLab.text=contentString;
            contentLab.numberOfLines=0;
            [headView addSubview:contentLab];
            
            // 如果是置顶帖
            if (self.isZhiDingTie) {
                contentLab.font=[UIFont systemFontOfSize:17];
            }
            
            
            NSMutableParagraphStyle *paragraphStyle = [[NSMutableParagraphStyle alloc] init];
            [paragraphStyle setLineSpacing:5];//调整行间距
            
            
            NSMutableAttributedString *str = [[NSMutableAttributedString alloc] initWithString:contentString];
            [str addAttribute:NSParagraphStyleAttributeName value:paragraphStyle range:NSMakeRange(0, [contentString length])];
            
            contentLab.attributedText = str;
            [contentLab sizeToFit];
            
            
            headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, CGRectGetMaxY(contentLab.frame)+5);
            begin_y =CGRectGetMaxY(contentLab.frame)+5;
            
            
            
            [self.contentLabAndImageArr addObject:contentLab];
            
        }else if([contentArr[i][@"type"] isEqualToString:@"img"])
        {
            if (firstImage) {
                firstIndex=i;
                firstImage=NO;
            }
            
            QzImageView *imageView=[[QzImageView alloc]initWithFrame:CGRectMake(10, begin_y, SCREEN_WIDTH-20, SCREEN_WIDTH-20)];
            imageView.backgroundColor=LIGHT_GRAY_COLOR;
            imageView.userInteractionEnabled=YES;
            [headView addSubview:imageView];
            
            
          
            
            headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y + imageView.height +5);
            begin_y +=imageView.height +5;
            
            
            [self.contentLabAndImageArr addObject:imageView];
        }
        
       
    }
    
    
    // 商品详情
    self.shopView.frame=CGRectMake(0, begin_y, SCREEN_WIDTH, 90);
    
    [self.shopViewLeftImage sd_setImageWithURL:[PublicMethod imgWithUrl:self.detailDic[@"goodsPath"]] placeholderImage:UIImageByName(@"bg.png")];
    self.shopViewNameLab.text=self.detailDic[@"goodsName"];
    self.shopViewPriceLab.text=[NSString stringWithFormat:@"￥%@",self.detailDic[@"goodsPrice"]];
    self.shopViewNumLab.text=[NSString stringWithFormat:@"月销量%@件",self.detailDic[@"salesVolume"]];
    
    [headView addSubview:self.shopView];
    
    begin_y +=90;
    
    begin_y -=10;
    // 商品推荐
    headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y);
    [self initBottomPicScrollView];
    begin_y +=MAKEOF5(210);
    
    
    // 显示女神导购
    if (isShowNvShenProductPingLun) {
        [self createThreeBtnWith:headView withHeight_y:begin_y];
        begin_y +=40;
    }
    
    //画白线
    UIImageView *line1=[[UIImageView alloc]initWithFrame:CGRectMake(0, begin_y-0.5, SCREEN_WIDTH, 0.5)];
    line1.backgroundColor=[UIColor lightGrayColor];
    line1.tag=10000;
    [headView addSubview:line1];
    
    //调整headView的高度 和白线的位置
    headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y);
    
    self.bbsDetailTableView.tableHeaderView = headView;
    
    //下载图片
    imageIndex=0;
    
    
    //去下载第一个图片
    if(!firstImage)
    {
        [self downImageWithIndex:firstIndex];
    }
    
    
    
    // 1.下拉刷新
    [self.bbsDetailTableView addHeaderWithTarget:self action:@selector(headerRereshing)];
    
    
    
    // 2.上拉加载更多(进入刷新状态就会调用self的footerRereshing)
    [self.bbsDetailTableView addFooterWithTarget:self action:@selector(footerRereshing)];
    
    // 设置文字(也可以不设置,默认的文字在MJRefreshConst中修改)
    
    self.bbsDetailTableView.footerPullToRefreshText = @"上拉可以加载更多数据了";
    self.bbsDetailTableView.footerReleaseToRefreshText = @"松开马上加载更多数据了";
    self.bbsDetailTableView.footerRefreshingText = @"正在帮你加载中...";
    
    
    
    //返回顶端的按钮 1
    
    goTopView=[[GoTopView alloc] initWithFrame:CGRectMake(SCREEN_WIDTH-60, SCREEN_HEIGHT, 44, 44)];
    goTopView.targetScrollView = self.bbsDetailTableView;
    goTopView.distanceByBottom = 100;
    [self.view addSubview:goTopView];
    
}

-(void)headerRereshing
{
    
//    [self.scrollView refrashData];
    [self performSelector:@selector(hearderRereshingEnd) withObject:nil afterDelay:2];
    
    [self requestBBSData];

}
-(void)hearderRereshingEnd
{
    // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
    [self.bbsDetailTableView headerEndRefreshing];
}


-(void)footerRereshing
{
    if (isShowNvShenProductPingLun && buttonClicked==1)
    {
        if (isHaveNextPagePingJia) {
            [self requestCommentListMore ];
        }else
        {
            // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
            [self.bbsDetailTableView footerEndRefreshing];
            self.promptLab.text=@"已加载到最后";
            [self showPromptLab];
        }
        
        
    }else{
        
        if (isHaveNextPage) {
            [self getMoreBBSData ];
        }else{
            // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
            [self.bbsDetailTableView footerEndRefreshing];
            self.promptLab.text=@"已加载到最后";
            [self showPromptLab];
        }
    }
}

-(void)downImageWithIndex:(int)index
{
    
    NSArray *contentArr=self.detailDic[@"contentArr"];
    QzImageView *imageView=(QzImageView *)self.contentLabAndImageArr[index];
    
    if (imageIndex==0) {
        imageArr=[[NSMutableArray alloc]init];
    }

    NSURL *imageurl=[PublicMethod bbsImgURlAndroidWithStr:contentArr[index][@"content"]] ;
    [imageView qzSetImageWithURL:imageurl placeholderImage:nil completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, NSURL *imageURL) {
        
        // 可点击图片放大
        [imageView addGestureRecognizer:[[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(imageViewTap:)]];
        imageView.tag=imageIndex+100;
        imageIndex++;
        //将图片 添加到数组
        if (image) {
            [imageArr addObject:image];
            
        }

        
        
        // 调整位置 并下载下一张图片
        [self downImageOverToFomartLabImageFrameWithIndex:index];
    }];
}

//图文混排的
-(void)downImageOverToFomartLabImageFrameWithIndex:(int)index
{
    CGFloat begin_y=firstBegin_Y;
    
    NSArray *contentArr=self.detailDic[@"contentArr"];
    for (int i=0; i<contentArr.count; i++) {
        
        // 文本
        if ([contentArr[i][@"type"] isEqualToString:@"text"]) {
            UILabel *contentLab=(UILabel *)self.contentLabAndImageArr[i];
            
            if (index>i) {//下载图片前面的lab 不用改变位置
                begin_y =CGRectGetMaxY(contentLab.frame)+5;
                
            }else{// 下载图片后面的lab
            
                CGRect frame=contentLab.frame;
                frame.origin.y=begin_y;
                contentLab.frame=frame;//改变该下载图片后面lab的位置
                
                begin_y =CGRectGetMaxY(contentLab.frame)+5;
                
            }
        }
        
        // 图片
        else
            if([contentArr[i][@"type"] isEqualToString:@"img"])
        {
            QzImageView *imageView=(QzImageView *)self.contentLabAndImageArr[i];
            
            if(index>i)//下载图片 前面的图片
            {
                begin_y =CGRectGetMaxY(imageView.frame)+5;
                
            }else if(index == i)//刚下载好的图片
            {
                CGSize imageSize=imageView.image.size;
                
                NSLog(@"imageSize %@  ",NSStringFromCGSize(imageSize));
                CGFloat imageHeight=imageSize.width==0 ? 0 : imageSize.height*(SCREEN_WIDTH-20)/imageSize.width;
                imageView.frame=CGRectMake(10, begin_y,(SCREEN_WIDTH-20),imageHeight );
               
                begin_y +=imageHeight +5;
    

            }else // 该图片在下载好的图片的下面
            {
                CGRect frame=imageView.frame;
                frame.origin.y=begin_y;
                
                begin_y =CGRectGetMaxY(imageView.frame)+5;
            }
        }
    }

    // 购物view
    self.shopView.frame=CGRectMake(0, begin_y, SCREEN_WIDTH, MAKEOF5(90));
    begin_y +=MAKEOF5(90);
    
    begin_y -=10;
    // 推荐商品
    self.bottomView.frame=CGRectMake(0, begin_y, SCREEN_WIDTH, MAKEOF5(180));
    begin_y +=MAKEOF5(180)+5;
    
    if (isShowNvShenProductPingLun) {
        [self createThreeBtnWith:headView withHeight_y:begin_y];
        begin_y +=40;
    }
    
    
    
    //调整headView的高度 和白线的位置
    headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y);
    self.bbsDetailTableView.tableHeaderView = headView;
    
    UIImageView *line=(UIImageView*)[headView viewWithTag:10000];
    line.frame=CGRectMake(0, begin_y-0.5, SCREEN_WIDTH, 0.5);
    
    
    
    
    if (index+1<contentArr.count) {
        //顺序下载 下一张图片
        for (int i=index+1; i<contentArr.count; i++) {
            if ([contentArr[i][@"type"] isEqualToString:@"img"]) {
                
                [self downImageWithIndex:i];
                
                return;
            }
        }
    }
    
}


#pragma mark 购买导购商品

- (IBAction)buyBtnClick:(id)sender {
    
    
    NSLog(@"点击了购买  shopId=%@",self.detailDic[@"goodsId"]);
    
    
    GoodsDetailTwoViewController *ctrVc = [[GoodsDetailTwoViewController alloc] initWithNibName:@"GoodsDetailTwoViewController" bundle:nil];
    ctrVc.hidesBottomBarWhenPushed = YES;
    ctrVc.goodsIdStr = [self.detailDic objectForKey:@"goodsId"];
//    ctrVc.classifyIdStr = [self.detailDic  objectForKey:@"goodsCategoryId"];
    [self.navigationController pushViewController:ctrVc animated:YES];
}
#pragma mark  底部相关推荐

-(void)initBottomPicScrollView
{
    if(self.bottomView)
    {
        [self.bottomView removeFromSuperview];
        self.bottomView=nil;
    }
    
    
    self.bottomView = [[UIView alloc] initWithFrame:CGRectMake(0, CGRectGetMaxY(headView.frame),SCREEN_WIDTH,MAKEOF5(210))];
    [headView addSubview:self.bottomView];
    
    
    self.bottomPicScrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0,MAKEOF5(40),SCREEN_WIDTH, MAKEOF5(170))];
    self.bottomPicScrollView.bounces = YES;
    self.bottomPicScrollView.pagingEnabled = YES;
    self.bottomPicScrollView.delegate = self;
    self.bottomPicScrollView.scrollsToTop=NO;
    [self.bottomView addSubview:self.bottomPicScrollView];
    
    UIView *line = [[UIView alloc] initWithFrame:CGRectMake(0, 0,SCREEN_WIDTH, MAKEOF5(10))];
    line.backgroundColor = [UIColor colorWithRed:244/255.f green:244/255.f blue:244/255.f alpha:1.0];
    [self.bottomView addSubview:line];
    
    UILabel *lab = [[UILabel alloc] initWithFrame:CGRectMake(MAKEOF5(10), MAKEOF5(15), MAKEOF5(100), MAKEOF5(21))];
    lab.backgroundColor = [UIColor clearColor];
    lab.textColor = [UIColor lightGrayColor];
    lab.font = [UIFont systemFontOfSize:14.0];
    lab.text = @"相关推荐:";
    [self.bottomView addSubview:lab];
    
    
    for (int i = 0; i < self.recommendArray.count; i++) {
        /*
         recommendedId = 8a04bc8b4b30e538014b33b88cf5067f;
         recommendedName = "\U675c\U857e\U65af\U907f\U5b55\U5957 \U8349\U8393\U679c\U547312\U53ea\U88c5 \U5b89\U5168\U5957";
         recommendedPath = "/upload/image/201501/small/02c53f3791b7436492c6b0fbe29f02ae.jpg";
         recommendedPrice = "44.0";
         */
        // 价格 名称 图片路径
        NSString *priceStr=[NSString stringWithFormat:@"￥:%.2f",[[[self.recommendArray objectAtIndex:i] objectForKey:@"recommendedPrice"] floatValue]];
        NSString *productName=[[self.recommendArray objectAtIndex:i] objectForKey:@"recommendedName"];
        NSString *pathStr = [[self.recommendArray objectAtIndex:i] objectForKey:@"recommendedPath"];
        
        
        
        UIButton *imgBtn = [UIButton buttonWithType:UIButtonTypeCustom];
        [imgBtn sd_setImageWithURL:[PublicMethod imgWithUrl:pathStr] forState:UIControlStateNormal placeholderImage:[UIImage imageNamed:@"bg.png"]];
        imgBtn.tag = i;
        imgBtn.frame = CGRectMake(MAKEOF5(10 + 106 * i), 0, MAKEOF5(90), MAKEOF5(90));
        [imgBtn addTarget:self action:@selector(imgBtnClickAction:) forControlEvents:UIControlEventTouchUpInside];
        [self.bottomPicScrollView addSubview:imgBtn];
        
        UILabel *nameLab = [[UILabel alloc] initWithFrame:CGRectMake(MAKEOF5(10 + 106 * i),MAKEOF5(93) , MAKEOF5(90), MAKEOF5(34))];
        nameLab.numberOfLines = 2;
        nameLab.text = productName ;
        nameLab.textColor = [UIColor lightGrayColor];
        nameLab.font = [UIFont systemFontOfSize:11.0];
        [self.bottomPicScrollView addSubview:nameLab];
        
        UILabel *piceLab = [[UILabel alloc] initWithFrame:CGRectMake(MAKEOF5(10 + 106 * i), MAKEOF5(125) , MAKEOF5(90), MAKEOF5(20))];
        piceLab.text = priceStr;
        piceLab.textColor = [UIColor orangeColor];
        piceLab.font = [UIFont systemFontOfSize:11.0];
        [self.bottomPicScrollView addSubview:piceLab];
        
        
    }
    
    if (self.recommendArray.count > 6) {
        [self.bottomPicScrollView setContentSize:CGSizeMake(SCREEN_WIDTH*3, MAKEOF5(170))];
    }else if (self.recommendArray.count > 3 && self.recommendArray.count < 6)
    {
        [self.bottomPicScrollView setContentSize:CGSizeMake(SCREEN_WIDTH*2, MAKEOF5(170))];
    }else
    {
        [self.bottomPicScrollView setContentSize:CGSizeMake(SCREEN_WIDTH, 170)];
    }
    
    
}

#pragma mark  底部相关推荐scrol按钮
-(void)imgBtnClickAction:(id)sender
{
    UIButton *btn = (UIButton *)sender;
    NSLog(@"%d",(int)btn.tag);
    GoodsDetailTwoViewController *ctrVc = [[GoodsDetailTwoViewController alloc] initWithNibName:@"GoodsDetailTwoViewController" bundle:nil];
    ctrVc.hidesBottomBarWhenPushed = YES;
    ctrVc.goodsIdStr = [[self.recommendArray objectAtIndex:btn.tag] objectForKey:@"recommendedId"];
//    ctrVc.classifyIdStr = [[self.recommendArray objectAtIndex:btn.tag] objectForKey:@"goodsCategoryId"];
    [self.navigationController pushViewController:ctrVc animated:YES];
    
    
    
    /*
     recommendedId = 8a04bc8b4b30e538014b33b88cf5067f;
     recommendedName = "\U675c\U857e\U65af\U907f\U5b55\U5957 \U8349\U8393\U679c\U547312\U53ea\U88c5 \U5b89\U5168\U5957";
     recommendedPath = "/upload/image/201501/small/02c53f3791b7436492c6b0fbe29f02ae.jpg";
     recommendedPrice = "44.0";
     */
}

#pragma mark 浏览图片
-(void)imageViewTap:(UITapGestureRecognizer*)tap
{
    NSLog(@"123");
    
    
    int count = (int)imageArr.count;
    // 1.封装图片数据
    NSMutableArray *photos = [NSMutableArray arrayWithCapacity:count];
    for (int i = 0; i<count; i++) {
        // 替换为中等尺寸图片
        //        NSString *url = [_urls[i] stringByReplacingOccurrencesOfString:@"thumbnail" withString:@"bmiddle"];
        MJPhoto *photo = [[MJPhoto alloc] init];
        //        photo.url = [NSURL URLWithString:url]; // 图片路径
        photo.srcImageView = (UIImageView *)[headView viewWithTag:100+i]; // 来源于哪个UIImageView
        [photos addObject:photo];
    }
    
    // 2.显示相册
    MJPhotoBrowser *browser = [[MJPhotoBrowser alloc] init];
    browser.currentPhotoIndex = tap.view.tag-100; // 弹出相册时显示的第一张图片是？
    browser.photos = photos; // 设置所有的图片
    [browser show];
}

#pragma mark 放大头像
-(void)headViewTap:(UITapGestureRecognizer *)tap
{
    if (IS_ShowBigHead) {
        // 1.封装图片数据
        NSMutableArray *photos = [NSMutableArray arrayWithCapacity:0];
        
        MJPhoto *photo = [[MJPhoto alloc] init];
        photo.srcImageView =(UIImageView *) tap.view; // 来源于哪个UIImageView
        [photos addObject:photo];
        
        
        // 2.显示相册
        MJPhotoBrowser *browser = [[MJPhotoBrowser alloc] init];
        browser.currentPhotoIndex = 0; // 弹出相册时显示的第一张图片是？
        browser.photos = photos; // 设置所有的图片
        [browser show];
    }
    
}


#pragma mark 两个按钮初始化
-(void)createThreeBtnWith:(UIView *)topBarView withHeight_y:(CGFloat)height_y{
    Begin_width_x=0 ;
    btnWidth=SCREEN_WIDTH/2. ;
    Begin_width_y=40 ;
    if (threeBtnBgView) {
        [threeBtnBgView removeFromSuperview];
        threeBtnBgView=nil;
    }
    
    threeBtnBgView=[[UIView alloc] initWithFrame:CGRectMake(0, height_y, SCREEN_WIDTH, Begin_width_y)];
    threeBtnBgView.backgroundColor=UICOLOR_RGB(244, 244, 244);
    [topBarView addSubview:threeBtnBgView];
    
    //日按钮
    dayBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    dayBtn.tag = 1;
    dayBtn.frame = CGRectMake(Begin_width_x, 0, btnWidth, Begin_width_y);
    [dayBtn setTitle:NSLocalizedString(@"商品评价",nil) forState:UIControlStateNormal];
    dayBtn.titleLabel.font=[UIFont fontWithName:k_Font size:16];
    [dayBtn setTitleColor: DARK_GRAY_COLOR  forState:UIControlStateNormal];
    [dayBtn setTitleColor:[UIColor colorWithRed:253/255.f green:113/255.f blue:163/255.f alpha:1.0] forState:UIControlStateSelected];
    
    [dayBtn addTarget:self action:@selector(threeBtnClick:) forControlEvents:UIControlEventTouchUpInside];
    [threeBtnBgView addSubview:dayBtn];
    
    //周按钮
    weekBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    weekBtn.tag = 2;
    weekBtn.frame = CGRectMake(Begin_width_x+btnWidth, 0, btnWidth, Begin_width_y);
    [weekBtn setTitle:NSLocalizedString(@"帖子评论",nil) forState:UIControlStateNormal];
    weekBtn.titleLabel.font=[UIFont fontWithName:k_Font size:16];
    [weekBtn setTitleColor:DARK_GRAY_COLOR forState:UIControlStateNormal];
    [weekBtn setTitleColor:[UIColor colorWithRed:253/255.f green:113/255.f blue:163/255.f alpha:1.0] forState:UIControlStateSelected];
    
    [weekBtn addTarget:self action:@selector(threeBtnClick:) forControlEvents:UIControlEventTouchUpInside];
    [threeBtnBgView addSubview:weekBtn];
    
    
    //下划线
    selectedView = [[UIImageView alloc] init];
    //    selectedView.image=[UIImage imageNamed:@"tab_fouce"];
    selectedView.backgroundColor=[UIColor colorWithRed:253/255.f green:113/255.f blue:163/255.f alpha:1.0];
    selectedView.frame = CGRectMake(Begin_width_x, Begin_width_y -1, btnWidth, 1);
    [threeBtnBgView addSubview:selectedView];
    
    
    selectedViewFrame1 = CGRectMake(Begin_width_x, Begin_width_y-1, btnWidth, 1);
    selectedViewFrame2 = CGRectMake(Begin_width_x+btnWidth, Begin_width_y-1, btnWidth, 1);
    if (buttonClicked==1) {
        dayBtn.selected=YES;
        weekBtn.selected=NO;
        selectedView.frame = selectedViewFrame1;
    }else {
        dayBtn.selected=NO;
        weekBtn.selected=YES;
        selectedView.frame = selectedViewFrame2;
    }
    
    
    
}
#pragma mark  按钮点击事件
-(void)threeBtnClick:(UIButton*)button{
    if (buttonClicked == button.tag){
        
        return;
    }
    buttonClicked = button.tag;
    switch (buttonClicked) {
        case 1:
        {
            
            selectedView.frame = selectedViewFrame1;
            dayBtn.selected=YES;
            weekBtn.selected=NO;
            
            
            //去掉刷新
//            [self.exchangeTableV removeFooter];
        }
            break;
        case 2:
        {
            
            selectedView.frame = selectedViewFrame2;
            dayBtn.selected=NO;
            weekBtn.selected=YES;
            
            
            // 2.上拉加载更多(进入刷新状态就会调用self的footerRereshing)
//            [self.exchangeTableV addFooterWithTarget:self action:@selector(footerRereshing)];
//            
//            // 设置文字(也可以不设置,默认的文字在MJRefreshConst中修改)
//            
//            self.exchangeTableV.footerPullToRefreshText = @"上拉可以加载更多数据了";
//            self.exchangeTableV.footerReleaseToRefreshText = @"松开马上加载更多数据了";
//            self.exchangeTableV.footerRefreshingText = @"正在帮你加载中...";
        }
            break;
        default:
        {
            
            selectedView.frame = selectedViewFrame1;
        }
            break;
    }
    
    [self.bbsDetailTableView reloadData];
    
}
#pragma mark 重新加载
//noNetworkView 3
-(void)noNetworkViewRefreshBtnClick
{
    [self requestBBSData];
}
#pragma mark -
-(void)requestBBSData
{
    //noNetworkView 2.1
    self.noNetworkView.noNetView.hidden = YES;
    self.noNetworkView.indicator.hidden = NO;
    [self.noNetworkView.indicator setCenter:CGPointMake(SCREEN_WIDTH/2., SCREEN_HEIGHT/2.)];
    [self.noNetworkView.indicator startAnimating];
    
    pageIndex=1;
    NSMutableDictionary *tempDic=[[NSMutableDictionary alloc]init];
    [tempDic setObject:@"10" forKey:@"pageSize"];
    [tempDic setObject:[NSString stringWithFormat:@"%d",(int)pageIndex] forKey:@"pageNo"];
    [tempDic setObject:self.topicId forKey:@"topicId"];
    
    if (isDesc) {
        [tempDic setObject:@"1" forKey:@"desc"];
    }
    
    if(ISLOGIN)
    {
        [tempDic setObject:LUNTANUSERID forKey:@"userId"];
    }
    
    NSLog(@"%@",tempDic);
    
    opration=[[MKHttpExchangeDemo shareMyInstance] requestExchangePostInfoNewWithDic:tempDic completionHandler:^(id responseObject)
     {
         NSDictionary *responseDic = responseObject;
         NSLog(@"--<>>%@--%@",responseDic,[responseDic objectForKey:@"message"]);
         
         //贴子回复内容 加入数组
         NSArray *datasource=[responseDic objectForKey:@"datasource"];
         if (datasource && ![datasource isKindOfClass:[NSNull class]]) {
             [self.bbsDataArr removeAllObjects];
             
             // 推荐商品 
             if (datasource && datasource.count>0) {
                 [_recommendArray removeAllObjects];
                 NSLog(@"recommended=====%@",[datasource[0] objectForKey:@"recommended"]);
                 [_recommendArray addObjectsFromArray:[datasource[0] objectForKey:@"recommended"]];
             }
             
             //去下载商品评论
             if(isShowNvShenProductPingLun)
             {
                 self.goodsId =[NSString stringWithFormat:@"%@",[datasource[0] objectForKey:@"goodsId"]];
                 
                 [self requestCommentList];
             }
             
             
             
             [PublicMethod formatRequestDataForAndroidForNvShenDaoGou:datasource toArray:self.bbsDataArr];
             
             //删除第一条数据 因为它是详情
             if (self.bbsDataArr.count>0) {
                 
                 self.detailDic=self.bbsDataArr[0];// 第一条详情数据 存下来
                 [self.bbsDataArr removeObjectAtIndex:0];
                 
                 NSLog(@"%@",self.detailDic);
                 // 过滤审核不过的帖子
                 NSMutableArray *tempArr=[[NSMutableArray alloc]initWithArray:self.bbsDataArr];
                 [self.bbsDataArr removeAllObjects];
                 for (int i=0;i<tempArr.count; i++) {
                     if ([tempArr[i][@"status"] isEqualToString:@"0"]) {
                         [self.bbsDataArr addObject:tempArr[i]];
                     }
                 }
                 
                 
                 if(self.bbsDetailTableView==nil){
                     [self initBBSTableView];
                     [self initToolBar];
                     
                 }else
                     [self.bbsDetailTableView reloadData];
                 
                 if ([self.detailDic[@"isCollect"] isEqualToString:@"1"]) {
                     collectBtn.selected=YES;
                 }else collectBtn.selected=NO;
                 
             }
             
             [self.bbsDetailTableView scrollRectToVisible:CGRectMake(0, 0, SCREEN_WIDTH, 1) animated:YES];
             
             [self JudgePageNumAndToalPage:responseDic[@"datasource"]];
             
             
             
             
             
             
//             //获得推荐商品
//             NSDictionary *params = [[NSDictionary alloc]init];
//             params = @{@"pageSizeApp":@"9",@"pageApp":@"1",@"categoryId":self.detailDic[@"recommended"],@"sorting":@"desc"};
//             
//             [self requestSortClassifyGoodsListWithDic:params withSortPath:@"goods!getGoodsAppByCompre.action"];
         }
         
         
         //noNetworkView 2.2
         [self.noNetworkView.indicator stopAnimating];
         [self.noNetworkView removeFromSuperview];
     } errorHandler:^(NSError *error) {
         
         //noNetworkView 2.3
         [self.noNetworkView.indicator stopAnimating];
         self.noNetworkView.indicator.hidden = YES;
         self.noNetworkView.noNetView.hidden = NO;
     }];
}



-(void)getMoreBBSData
{
    pageIndex++;
    
    NSMutableDictionary *tempDic=[[NSMutableDictionary alloc]init];
    [tempDic setObject:@"10" forKey:@"pageSize"];
    [tempDic setObject:[NSString stringWithFormat:@"%d",(int)pageIndex] forKey:@"pageNo"];
    [tempDic setObject:self.topicId forKey:@"topicId"];
    if (isDesc) {
        [tempDic setObject:@"1" forKey:@"desc"];
    }
    
    opration=[[MKHttpExchangeDemo shareMyInstance] requestExchangePostInfoNewWithDic:tempDic completionHandler:^(id responseObject)
     {
         NSDictionary *responseDic = responseObject;
         NSLog(@"--<>>%@--%@",responseDic,[responseDic objectForKey:@"message"]);
         
         //贴子回复内容 加入数组
         NSArray *datasource=[responseDic objectForKey:@"datasource"];
         if (datasource) {
      
             
             [PublicMethod formatRequestDataForAndroidForNvShenDaoGou:datasource toArray:self.bbsDataArr];
             
             // 过滤审核不过的帖子
             NSMutableArray *tempArr=[[NSMutableArray alloc]initWithArray:self.bbsDataArr];
             [self.bbsDataArr removeAllObjects];
             for (int i=0;i<tempArr.count; i++) {
                 if ([tempArr[i][@"status"] isEqualToString:@"0"]) {
                     [self.bbsDataArr addObject:tempArr[i]];
                 }
             }
             
             
             [self.bbsDetailTableView reloadData];
             [self JudgePageNumAndToalPage:responseDic[@"datasource"]];
             
             // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
             [self.bbsDetailTableView footerEndRefreshing];
             
         }
     } errorHandler:^(NSError *error) {
         // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
         [self.bbsDetailTableView footerEndRefreshing];
     }];
}


#pragma mark MKHttpRequestAction  GoodsList
-(void)requestCommentList
{
   
    currentCommentPage=1;
    NSDictionary *dic = [[NSDictionary alloc]init];
    
    dic = @{@"pageApp":[NSString stringWithFormat:@"%d",currentCommentPage],@"pageSizeApp":@"20",@"commentGoodId":self.goodsId};
    
    
    [[MKHttpServiceEngine shareMyInstance] requestCommentListWithDic:dic completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        
        NSLog(@"arry-->%@",responseDic);
        
        if ([[responseDic objectForKey:@"success"] boolValue] == 1) {
            
            self.pingJiaArray =[[NSMutableArray alloc] initWithCapacity:0];

            [self.pingJiaArray removeAllObjects];
            
            [self.pingJiaArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
            
            
        }else
        {
          
        }
        
        if ([responseDic[@"datasource"] count]>19) {
            isHaveNextPagePingJia=YES;
        }else
        {
            isHaveNextPagePingJia=NO;
        }
        
        
    } errorHandler:^(NSError *error) {
        
        NSLog(@"error-->%@",error);

        
    }];
    
}

-(void)requestCommentListMore
{
    
    currentCommentPage ++;
    
    NSDictionary *dic = [[NSDictionary alloc]init];
    
    dic = @{@"pageApp":[NSString stringWithFormat:@"%d",currentCommentPage],@"pageSizeApp":@"20",@"commentGoodId":self.goodsId};
    
    
    
    
    [[MKHttpServiceEngine shareMyInstance] requestCommentListWithDic:dic completionHandler:^(id responseObject) {
        
        NSDictionary *responseDic = responseObject;
        NSLog(@"arrys-->%@",responseDic);
        
        if ([[responseDic objectForKey:@"success"] boolValue] == 1) {
            if ([self.pingJiaArray containsObject:[[responseDic objectForKey:@"datasource"] firstObject]]) {
             
            }else
            {
                [self.pingJiaArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
            }
            
            if ([responseDic[@"datasource"] count]>19) {
                isHaveNextPagePingJia=YES;
            }else
            {
                isHaveNextPagePingJia=NO;
            }
            
            [self.bbsDetailTableView reloadData];
        }
        
        NSLog(@"arry-->%@",responseDic);
        
        
        // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
        [self.bbsDetailTableView footerEndRefreshing];
        
    } errorHandler:^(NSError *error) {
        
        NSLog(@"error-->%@",error);
        
        currentCommentPage--;
        // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
        [self.bbsDetailTableView footerEndRefreshing];
    }];
    
}


#pragma mark MKHttpRequestAction  SortGoodsList 相关推荐
-(void)requestSortClassifyGoodsListWithDic:(NSDictionary *)dic  withSortPath:(NSString *)sortStr
{
    
    
    [[MKHttpServiceEngine shareMyInstance] requestSortGoodsListWithDic:dic withSortPath:sortStr completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        
        if ([[responseDic objectForKey:@"success"] boolValue] == 1) {
            
            if ([[responseDic objectForKey:@"datasource"] count] > 0 ) {
                [_recommendArray removeAllObjects];
                
                [_recommendArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
                
                [self initBottomPicScrollView];
            }
            
            
        }else
        {
            self.promptLab.text = [responseDic objectForKey:@"message"];
            [self showPromptLab];
            
        }
        
        
        
    } errorHandler:^(NSError *error) {
        
        NSLog(@"error-->%@",error);
        
    }];
    
}


//添加触底刷新
-(void)JudgePageNumAndToalPage:(NSArray *)dataSource
{
    if ([dataSource count] >9) {
        isHaveNextPage=YES;
      
    }else
    {
        isHaveNextPage=NO;

    }
}


//处理下载的数据
-(void)formatRequestData:(NSArray *)dataSource
{
    for (NSDictionary *tempDic in dataSource) {
        NSMutableDictionary *dic=[[NSMutableDictionary alloc]init];
        //用户
        NSString *user=[NSString stringWithFormat:@"%@",tempDic[@"username"]];
        [dic setObject:user forKey:@"username"];
        
        if (tempDic[@"nickname"] && ![tempDic[@"nickname"] isKindOfClass:[NSNull class]]) {
            NSString *nickname=[NSString stringWithFormat:@"%@",tempDic[@"nickname"]];
            [dic setObject:nickname forKey:@"nickname"];
        }
        
        //头像
        NSString *headUrl=[NSString stringWithFormat:@"%@",tempDic[@"avatar"]];
        [dic setObject:[PublicMethod formatBBSHeadeImageWithImageStr:headUrl] forKey:@"headImage"];
        
        NSString *createTime=[NSString stringWithFormat:@"%@",tempDic[@"createTime"]];
        [dic setObject:createTime forKey:@"createTime"];
        
        NSString *title=[NSString stringWithFormat:@"%@",tempDic[@"title"]];
        [dic setObject:title forKey:@"title"];
        
        NSString *content=[NSString stringWithFormat:@"%@",[PublicMethod clearHtmlTag:tempDic[@"contentHtml"]]];
        [dic setObject:content forKey:@"content"];
        
        NSString *replyCount=[NSString stringWithFormat:@"%@",tempDic[@"editCount"]];
        [dic setObject:replyCount forKey:@"editCount"];
        
        NSString *postTypeId=[NSString stringWithFormat:@"%@",tempDic[@"postTypeId"]];
        [dic setObject:postTypeId forKey:@"postTypeId"];
        
        NSString *id=[NSString stringWithFormat:@"%@",tempDic[@"id"]];
        [dic setObject:id forKey:@"id"];
        
        NSString *sex=[NSString stringWithFormat:@"%@",tempDic[@"sex"]];
        [dic setObject:sex forKey:@"sex"];
        
        
        [self.bbsDataArr addObject:dic];
    }
    
}

#pragma mark- tableView detegate
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView;
{
    //    return self.bbsDataArr.count;
    return 1;
}
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    //    return 1;
    if(isShowNvShenProductPingLun && buttonClicked==1)
        return self.pingJiaArray.count;
    else
        return self.bbsDataArr.count;
}



- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (isShowNvShenProductPingLun && buttonClicked==1) {
        NSDictionary *dic = [self.pingJiaArray objectAtIndex:indexPath.row];
        CGSize detailSize = [[NSString stringWithFormat:@"%@",[dic objectForKey:@"content"]] sizeWithFont:[UIFont systemFontOfSize:12.0]
                                                                                        constrainedToSize:CGSizeMake(245, 600)
                                                                                            lineBreakMode:NSLineBreakByWordWrapping];
        return detailSize.height + 55;
    }else
    {
        if (self.bbsDataArr.count>0) {
            NSString *contentStr=[self.bbsDataArr[indexPath.row][@"contentArr"] firstObject][@"content"];//女神导购
            CGSize labelsize = [contentStr sizeWithFont:[UIFont systemFontOfSize:14] constrainedToSize:CGSizeMake(250,2000) lineBreakMode:NSLineBreakByCharWrapping];
            
            if (!IS_OFFBBSSecond) {
                if(self.bbsDataArr[indexPath.row][@"secondary"] && [self.bbsDataArr[indexPath.row][@"secondary"] lastObject] )
                {
                    NSInteger num=[self.bbsDataArr[indexPath.row][@"secondaryCount"] integerValue];
                    
                    if (num>1) {
                        return 56+labelsize.height+13 +60;
                        
                    }else return 56+labelsize.height+13 +30;
                }else  return 56+labelsize.height+13;
            }else{
                return 56+labelsize.height+13;
            }
            
        }else return 88;
    }
  
    
    
}



- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
 
    if (isShowNvShenProductPingLun && buttonClicked==1) {
        static NSString *CellIdentifier = @"CommentCell";
        CommentCell *cell = (CommentCell *)[tableView dequeueReusableCellWithIdentifier:CellIdentifier];
        if (cell == nil) {
            cell = [[[NSBundle mainBundle] loadNibNamed:@"CommentCell" owner:self options:nil] lastObject];
        }
        
        cell.backgroundColor = [UIColor whiteColor];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        //    cell.textLabel.text = @"基本参数";
        //    [cell configCellWithArray:nil];
        
        
        NSDictionary *dic = [self.pingJiaArray objectAtIndex:indexPath.row];
        NSString *nameStr=nil;
        if (![[dic objectForKey:@"nickname"] isKindOfClass:[NSNull class]]) {
            if ([dic[@"nickname"] length]==1) {
                nameStr=[NSString stringWithFormat:@"%@***",dic[@"nickname"]];
            }else if([dic[@"nickname"] length]>1)
            {
                nameStr=[NSString stringWithFormat:@"%@***%@",[dic[@"nickname"] substringWithRange:NSMakeRange(0,1)],[dic[@"nickname"] substringWithRange:NSMakeRange([dic[@"nickname"] length]-1,1)]];
            }else nameStr=@"***";
            
        }else nameStr=@"***"; // 昵称不存在用***
        
        cell.nameLab.text = nameStr;
        cell.timeLab.text = [[NSString stringWithFormat:@"%@",[dic objectForKey:@"createTime"]]   substringToIndex:10];
        cell.desLab.text = [NSString stringWithFormat:@"%@",[dic objectForKey:@"content"]];
        
        
        // time 位置
        cell.timeLab.frame = CGRectMake(175, cell.frame.size.height - 22, 130, 18);
        
        // 内容 位置
        CGSize detailContentSize = [[NSString stringWithFormat:@"%@",[dic objectForKey:@"content"]] sizeWithFont:[UIFont systemFontOfSize:12.0]
                                                                                               constrainedToSize:CGSizeMake(295, 600)
                                                                                                   lineBreakMode:NSLineBreakByWordWrapping];
        cell.desLab.frame = CGRectMake(10, 30, 295, detailContentSize.height+2);
        
        // 根据name 判断星星位置
        CGSize detailSize = [[NSString stringWithFormat:@"%@",nameStr] sizeWithFont:[UIFont systemFontOfSize:14.0]
                                                                  constrainedToSize:CGSizeMake(165, 21)
                                                                      lineBreakMode:NSLineBreakByWordWrapping];
        CGFloat detailwidth=detailSize.width;
        if (detailSize.width>165) {
            detailwidth=165;
        }
        cell.nameLab.frame=CGRectMake(10,cell.nameLab.frame.origin.y,cell.nameLab.frame.size.width , cell.nameLab.frame.size.height);
        // 心形评分
        //    cell.pfStarView.frame = CGRectMake(detailwidth + 70, 13, 70, 18);
        cell.pfStarView.frame = CGRectMake(detailwidth + 17, 13, 70, 18);
        
        float pingfen = ([[dic objectForKey:@"deliverySpeed"] floatValue] + [[dic objectForKey:@"deliverySpeed"] floatValue] + [[dic objectForKey:@"deliverySpeed"] floatValue])/3.0;
        cell.pfStarView.isMin=YES;
        cell.pfStarView.imageMultiple=0.75;
        [cell.pfStarView setImagesDeselected:@"star0.png" partlySelected:@"star1.png" fullSelected:@"star2.png"];
        [cell.pfStarView displayRating:pingfen];
        
        return cell;

    }else{
    
        static NSString *CellIdentifier = @"BBSDetailCell";
        BBSDetailCell *cell = (BBSDetailCell *)[tableView dequeueReusableCellWithIdentifier:CellIdentifier];
        if (cell == nil) {
            cell = [[[NSBundle mainBundle] loadNibNamed:@"BBSDetailCell" owner:self options:nil] lastObject];
            
        }
        
        cell.backgroundColor = [UIColor whiteColor];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        //头像
        cell.headImage.layer.cornerRadius=5;
        cell.headImage.layer.masksToBounds = YES;
        
        [cell configCellWithArrayForNvShenDaoGou:self.bbsDataArr indexRow:indexPath];
        
        
        
        //二级回复
        if(!IS_OFFBBSSecond &&  self.bbsDataArr[indexPath.row][@"secondary"] && [self.bbsDataArr[indexPath.row][@"secondary"] lastObject] )
        {
            
            UILabel *huifu1=[[UILabel alloc]initWithFrame:CGRectMake(51,CGRectGetMaxY(cell.contentLab.frame) +2 , SCREEN_WIDTH-51, 30)];
            huifu1.text=@"测试用户：用户留言内容";
            huifu1.backgroundColor=[UIColor clearColor];
            huifu1.font=[UIFont systemFontOfSize:13];
            [cell addSubview:huifu1];
            
            
            
            
            UILabel *timeLab=[[UILabel alloc]initWithFrame:CGRectMake(51,CGRectGetMaxY(cell.contentLab.frame) +2 , SCREEN_WIDTH-10-51, 30)];
            timeLab.text=@"2015-09-23";
            timeLab.backgroundColor=[UIColor clearColor];
            timeLab.textAlignment=NSTextAlignmentRight;
            timeLab.textColor=[UIColor lightGrayColor];
            timeLab.font=[UIFont systemFontOfSize:10];
            [cell addSubview:timeLab];
            
            NSString *timeStr=@"";
            timeStr=[NSString stringWithFormat:@"%@",[PublicMethod intervalSinceNow:self.bbsDataArr[indexPath.row][@"createTime"]]];
            timeLab.text=timeStr;
            
            CGSize labelsize = [timeStr sizeWithFont:[UIFont systemFontOfSize:10] constrainedToSize:CGSizeMake(250,30) lineBreakMode:NSLineBreakByCharWrapping];
            CGFloat length=labelsize.width;
            CGRect huifuRect=huifu1.frame;
            huifu1.frame=CGRectMake(huifuRect.origin.x, huifuRect.origin.y, SCREEN_WIDTH-10-51-length-2, huifuRect.size.height);
            
            NSString *secondaryContent=@"";
            if ([self.bbsDataArr[indexPath.row][@"secondary"] lastObject][@"secondaryContent"]) {
                secondaryContent=[self.bbsDataArr[indexPath.row][@"secondary"] lastObject][@"secondaryContent"];
            }
            
            NSString *secondaryName=@"***";
            if ([self.bbsDataArr[indexPath.row][@"secondary"] firstObject][@"secondaryName"] && ![[self.bbsDataArr[indexPath.row][@"secondary"] firstObject][@"secondaryName"] isKindOfClass:[NSNull class]]) {
                
                secondaryName=[NSString stringWithFormat:@"%@",[self.bbsDataArr[indexPath.row][@"secondary"] firstObject][@"secondaryName"]];
            }
            
            NSString *contentAll=[NSString stringWithFormat:@"%@:%@",secondaryName,secondaryContent];
            
            //用户名加颜色
            NSMutableAttributedString *str7 = [[NSMutableAttributedString alloc] initWithString:contentAll];
            [str7 addAttribute:NSForegroundColorAttributeName value:ColorSecondName range:NSMakeRange(0,secondaryName.length+1)];
            huifu1.attributedText = str7;
            
            
            //更多评论个数
            if (self.bbsDataArr[indexPath.row][@"secondaryCount"])
            {
                
                NSInteger num=[self.bbsDataArr[indexPath.row][@"secondaryCount"] integerValue];
                
                if (num>1) {
                    //背景
                    UIImageView *cellBgView=[[UIImageView alloc]initWithFrame:CGRectMake(45,CGRectGetMaxY(cell.contentLab.frame) +2, SCREEN_WIDTH-50, 60)];
                    
                    UIImage *img=[UIImage imageNamed:@"BBSCellSecondBg"];
                    img=[img stretchableImageWithLeftCapWidth:150 topCapHeight:15];
                    cellBgView.image=img;
                    [cell addSubview:cellBgView];
                    
                    
                    
                    UIButton *moreHuiFu=[UIButton buttonWithType:0];
                    moreHuiFu.frame=CGRectMake(200, CGRectGetMaxY(huifu1.frame) +2, 120, 30) ;
                    [moreHuiFu setTitleColor:ColorSecondName forState:0];
                    [moreHuiFu setTitle:[NSString stringWithFormat:@"查看全部%d条评论",(int)num ] forState:0];
                    [moreHuiFu.titleLabel setFont:[UIFont systemFontOfSize:12]];
                    [moreHuiFu addTarget:self action:@selector(moreHuiFuClick:) forControlEvents:UIControlEventTouchUpInside];
                    moreHuiFu.tag=indexPath.row;
                    [cell addSubview:moreHuiFu];
                    
                }else{
                    
                    //背景
                    UIImageView *cellBgView=[[UIImageView alloc]initWithFrame:CGRectMake(45,CGRectGetMaxY(cell.contentLab.frame) +2, SCREEN_WIDTH-50, 30)];
                    
                    UIImage *img=[UIImage imageNamed:@"BBSCellSecondBg"];
                    img=[img stretchableImageWithLeftCapWidth:150 topCapHeight:15];
                    cellBgView.image=img;
                    [cell addSubview:cellBgView];
                    
                }
            }
            
        }
        
        
        
        
        return cell;
        

    }
}

-(void)moreHuiFuClick:(UIButton *)sender
{
    BBSDetailCellViewController *moreCellDetail=[[BBSDetailCellViewController alloc]initWithNibName:@"BBSDetailCellViewController" bundle:[NSBundle mainBundle]];
    moreCellDetail.hidesBottomBarWhenPushed=YES;
    moreCellDetail.postId=self.bbsDataArr[sender.tag][@"id"];
    moreCellDetail.detailDic=self.bbsDataArr[sender.tag];
    moreCellDetail.forumId=self.forumId;
    [self.navigationController pushViewController:moreCellDetail animated:YES];
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    if (!IS_OFFBBSSecond) {
        BBSDetailCellViewController *moreCellDetail=[[BBSDetailCellViewController alloc]initWithNibName:@"BBSDetailCellViewController" bundle:[NSBundle mainBundle]];
        moreCellDetail.hidesBottomBarWhenPushed=YES;
        moreCellDetail.postId=self.bbsDataArr[indexPath.row][@"id"];
        moreCellDetail.detailDic=self.bbsDataArr[indexPath.row];
        moreCellDetail.forumId=self.forumId;
        moreCellDetail.isFirstShowKeyboard=YES;
        [self.navigationController pushViewController:moreCellDetail animated:YES];
    }
    
    
    
}


#pragma mark -
#pragma mark UIScrollViewDelegate Methods


- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    
    //返回顶端的按钮 3
    [goTopView scrollViewDidScroll:scrollView];
}



//显示提示
-(void)showPromptLab
{
    [self.view addSubview:self.promptLab];
    [UIView animateWithDuration:1.0 delay:0.0 options:UIViewAnimationOptionCurveEaseIn animations:^{self.promptLab.alpha = 0.6;} completion:nil];
    [self performSelector:@selector(dismissPromptLab) withObject:nil afterDelay:0.0];
}
//提示消失
-(void)dismissPromptLab
{
    [UIView animateWithDuration:1.0 delay:1.0 options:UIViewAnimationOptionCurveEaseIn animations:^{self.promptLab.alpha = 0.0;} completion:^(BOOL finished) {
        [self.promptLab removeFromSuperview];
    }];
}


- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end

