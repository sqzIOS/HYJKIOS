//
//  BBSDetailNewViewController.m
//  sexduoduo
//
//  Created by dsz on 15-2-10.
//  Copyright (c) 2015年 dbCode. All rights reserved.
//

#import "BBSDetailNewViewController.h"

#import "BBSDetailCellViewController.h"
#import "LoginViewController.h"
#import "MJPhotoBrowser.h"
#import "MJPhoto.h"

#import "UMSocial.h"
#import "KWPopoverView.h"
#import "DetailNavRightPopView.h"

#import "MJRefresh.h"
#import "SDBBSDetailObj.h"
#import "SDBBSDetailBottomView.h"
#import "QzMessageToolBar.h"

@interface BBSDetailNewViewController ()<UITextFieldDelegate,UIAlertViewDelegate,UIActionSheetDelegate,UMSocialUIDelegate,DetailNavRightViewDelegate,UIGestureRecognizerDelegate,BBSDetailBottomViewBtnClick,QzMessageToolBarDelegate>
{
    UIView *headView;
    UIView *headBottomView;
    int imageIndex;
    CGFloat firstBegin_Y;//图文混排的第一个lab 或imageView的位置
    NSMutableArray *imageArr;
    
    
    UIActionSheet * shareSheet;
    UIActionSheet * juBaoSheet;
    
    BOOL isDesc;
    BOOL isHaveNextPage;

    
    BOOL isBack;
    
}
@property(nonatomic ,strong)SDBBSDetailObj *detailObj;
@property(nonatomic ,strong)SDBBSDetailBottomView *bottomView;//点赞 吐槽 评论 按钮
@property(nonatomic , strong)QzMessageToolBar *chatToolBar;// 聊天 toolBar


@end

@implementation BBSDetailNewViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}
-(void)dealloc
{
    
    [[NSNotificationCenter defaultCenter] removeObserver:self];
    
}

-(void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
}
-(void)viewWillDisappear:(BOOL)animated
{
    [super viewWillDisappear:animated];
    
    //1.
    [opration cancel];
    opration =nil;
    
    //2.
    //2.取消图文详情的下载
   
    for (int i=0; i<self.contentLabAndImageArr.count; i++) {
        if ([self.contentLabAndImageArr[i] isKindOfClass:[QzImageView class]]) {
            QzImageView *imageView=self.contentLabAndImageArr[i];
            [imageView qzCancelCurrentImageLoad];
        }
    }
    
    
}

-(void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:animated];
}
-(void)viewDidDisappear:(BOOL)animated
{
    [super viewDidDisappear:animated];

    
    [opration cancel];
}


//返回
-(void)toBackView
{
    isBack=YES;
    
    if(self.isBackToJumpBBS){
        
        [self.navigationController popViewControllerAnimated:YES];
        
        [m_appDelegate.tabController setSelectedIndex:2];
        
    }else
        [self.navigationController popViewControllerAnimated:YES];
    
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    [self setTopNavView];
    
    
    pageIndex=1;
    isDesc = NO;
    
//    //TODO: 测试先打开 正式注释掉这两个
//    [self initBBSTableView];
//    [self initToolBar];
//    return;
    
    self.detailObj = [[SDBBSDetailObj alloc] init];
    
    
    //noNetworkView 1
    self.noNetworkView =(NoNetworkView *)[[[NSBundle mainBundle] loadNibNamed:@"NoNetworkView" owner:self options:nil] lastObject];
    self.noNetworkView.delegate=self;
    self.noNetworkView.frame = CGRectMake(0, STAR_Y, SCREEN_WIDTH,SCREEN_HEIGHT);
    [self.view addSubview:self.noNetworkView];
    
    
    
    //下载内容
    self.bbsDataArr=[[NSMutableArray alloc]init];//源数据
    self.bbsHotDataArr = [[NSMutableArray alloc] init];//最热的回复
    self.contentLabAndImageArr=[[NSMutableArray alloc]init];//lab 和 imageView的存储数组
    [self requestBBSData];
    
    
    self.promptLab = [[UILabel alloc] initWithFrame:CGRectMake(0, STAR_Y, SCREEN_WIDTH, 35)];
    self.promptLab.backgroundColor = [UIColor blackColor];
    self.promptLab.alpha = 0.0;
    self.promptLab.font = [UIFont systemFontOfSize:14.0];
    self.promptLab.textColor = [UIColor whiteColor];
    self.promptLab.textAlignment = NSTextAlignmentCenter;
    
    
    
}



//顶部NavView
-(void)setTopNavView
{
    int imgY = -20;
    if (IOS7_OR_LATER) {
        imgY = 0;
    }
    
    TopNavView *navView=[[TopNavView alloc] initWithFrame:CGRectMake(0, imgY,SCREEN_WIDTH, 64)];
    [self.view addSubview:navView];
    
    [navView addLeftBtnTarget:self action:@selector(toBackView) forControlEvents:UIControlEventTouchUpInside];
    
    [navView setTitleStr:@"帖子详情"];
    
    
    
    UIButton *rightBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    rightBtn.frame = CGRectMake(SCREEN_WIDTH - 52, 20 , 44, 44);
    [rightBtn addTarget:self action:@selector(replyBBSAction:) forControlEvents:UIControlEventTouchUpInside];
    [navView addSubview:rightBtn];
    
    UIImageView *rightBtnImg = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0 , 20, 20)];
    [rightBtnImg setImage:[UIImage imageNamed:@"BBS_navRight.png"]];
    rightBtnImg.backgroundColor = [UIColor clearColor];
    rightBtnImg.center=CGPointMake(22, 22);
    [rightBtn addSubview:rightBtnImg];
    
    
}



#pragma mark 分享
-(void)shareAction:(id)sender
{
    NSLog(@"分享");
    
    NSArray *nameStrArr=@[@"微信好友",@"微信朋友圈"];
    //自定义列表
    shareSheet = [[UIActionSheet alloc] initWithTitle:@"分享" delegate:self cancelButtonTitle:nil destructiveButtonTitle:nil otherButtonTitles:nil];
    for (int i=0; i<nameStrArr.count; i++) {
        [shareSheet addButtonWithTitle:nameStrArr[i]];
    }
    [shareSheet addButtonWithTitle:@"取消"];//默认的如果写在cancelbtn上 位置就变为0了
    shareSheet.cancelButtonIndex = shareSheet.numberOfButtons - 1;
    shareSheet.delegate = self;
    [shareSheet showInView:self.view];
}

- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (actionSheet==shareSheet) {
        if (buttonIndex + 1 >= actionSheet.numberOfButtons ) {
            return;
        }
        
        [ShareFunction showHUDWithText:@"请骚等..."];
        NSMutableDictionary *dic=[[NSMutableDictionary alloc] init];
        
        [dic setObject:self.topicId forKey:@"topicId"];
        
        [[MKHttpExchangeDemo shareMyInstance] requestBBSAppTopicShareWithDic:dic completionHandler:^(id responseObject) {
            NSLog(@"分享链接%@",responseObject);
            
            
            NSDictionary *responseDic=responseObject;
            
            if ([responseDic[@"success"] intValue]==1) {
                //分享编辑页面的接口,snsName可以换成你想要的任意平台，例如UMShareToSina,UMShareToWechatTimeline
                NSArray *snsNameArr=@[UMShareToWechatSession,UMShareToWechatTimeline];
                NSLog(@"buttonindex=%d",(int)buttonIndex);
                if (buttonIndex==0) {
                    snsNameArr=@[UMShareToWechatSession];
                }else if(buttonIndex==1)
                {
                    snsNameArr=@[UMShareToWechatTimeline];
                }
                
                NSString *shareUrl =responseDic[@"datasource"];
                NSString *shareText = self.detailDic[@"title"]  ;
                UIImage *shareImage = [UIImage imageNamed:@"Icon60"];
                
                appType=WECHAT_RET;
                
                
                if(buttonIndex==0)
                {
                    [UMSocialData defaultData].extConfig.wechatSessionData.url = shareUrl;//链接
                    [UMSocialData defaultData].extConfig.wechatSessionData.title = @"性多多泡吧";//title
                    [[UMSocialDataService defaultDataService]  postSNSWithTypes:snsNameArr content:shareText image:shareImage location:nil urlResource:nil presentedController:self completion:^(UMSocialResponseEntity *response){
                        if (response.responseCode == UMSResponseCodeSuccess) {
                            NSLog(@"分享成功！");
                        }
                    }];
                }else{
                    [UMSocialData defaultData].extConfig.wechatTimelineData.url = shareUrl;
                    
                    //朋友圈只显示titile
                    [UMSocialData defaultData].extConfig.wechatTimelineData.title = shareText;
                    
                    [[UMSocialDataService defaultDataService]  postSNSWithTypes:snsNameArr content:shareText image:shareImage location:nil urlResource:nil presentedController:self completion:^(UMSocialResponseEntity *response){
                        if (response.responseCode == UMSResponseCodeSuccess) {
                            NSLog(@"分享成功！");
                        }
                    }];
                    
                }
                
            }
            [ShareFunction hiddenHUD];
        } errorHandler:^(NSError *error) {
            NSLog(@"获取分享链接失败");
            [ShareFunction hiddenHUD];
        }];
        
    }else if(actionSheet == juBaoSheet)
    {
        NSLog(@"点击举报按钮=%d",(int)buttonIndex);
        if (buttonIndex>=0 && buttonIndex<=4) {
            NSArray *arr=@[@"广告", @"色情",@"骚扰",@"泄露隐私",@"其他"];
            NSMutableDictionary *dic=[[NSMutableDictionary alloc] init];
            
            //            [dic setObject:self.topicId forKey:@"postId"];
            [dic setObject:self.detailDic[@"id"] forKey:@"postId"];
            [dic setObject:arr[buttonIndex] forKey:@"reason"];
            [dic setObject:LUNTANUSERID forKey:@"userId"];
            
            [[MKHttpExchangeDemo shareMyInstance] requestBBSAppReportWithDic:dic completionHandler:^(id responseObject) {
                NSDictionary *dic=responseObject;
                NSLog(@"举报%@--%@",dic,dic[@"message"]);
                
                
                self.promptLab.text=dic[@"message"];
                [self showPromptLab];
            } errorHandler:^(NSError *error) {
                NSLog(@"举报失败");
            }];
        }
    }
}


//可选的回掉方法
-(void)didFinishGetUMSocialDataInViewController:(UMSocialResponseEntity *)response
{
    //根据`responseCode`得到发送结果,如果分享成功
    if(response.responseCode == UMSResponseCodeSuccess)
    {
        //得到分享到的微博平台名
        NSLog(@"share to sns name is %@",[[response.data allKeys] objectAtIndex:0]);
    }
}



//收藏 帖子
-(void)replyBBSAction:(UIButton *)sender
{
    DetailNavRightPopView *topAlert=[[[NSBundle mainBundle] loadNibNamed:@"DetailNavRightPopView" owner:self options:nil] lastObject];
    topAlert.topAlertViewDelegate=self;
    topAlert.frame=CGRectMake(SCREEN_WIDTH-120, STAR_Y, 110, 145);
    
    [KWPopoverView showPopoverAtPoint:sender.center inView:self.view withContentView:topAlert andRejectTouchBackOrNO:NO];
    
}

-(void)detailNavRightViewButtonClick:(NSInteger)index
{
    if (index==0) {// 分享
        
        NSLog(@"倒序查看");
        
        isDesc = !isDesc;
        [self requestBBSData];
        
        
    }else if (index==1)//分享
    {
        
        NSLog(@"分享");
        
        [self shareAction:nil];
    }else if(index == 2)//举报
    {
        NSLog(@"举报");
        
        if (ISLOGIN) {
            juBaoSheet = [[UIActionSheet alloc]
                          initWithTitle:@"请选择举报理由"
                          delegate:self
                          cancelButtonTitle:@"取消"
                          destructiveButtonTitle:nil
                          otherButtonTitles: @"广告", @"色情",@"骚扰",@"泄露隐私",@"其他",nil];
            
            [juBaoSheet showInView:self.view];
        }else{
            UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
            alert.tag=111;
            [alert show];
            
            return;
        }
    }else{//收藏
        
        NSLog(@"收藏");
        if (ISLOGIN) {
            NSMutableDictionary *dic=[[NSMutableDictionary alloc]init];
            [dic setObject:LUNTANUSERID forKey:@"userId"];
            [dic setObject:self.topicId forKey:@"topicId"];
            
         [[MKHttpExchangeDemo shareMyInstance] requestBBSCollectWithDic:dic completionHandler:^(id responseObject) {
                
                NSDictionary *responseDic = responseObject;
                NSLog(@"--<>>%@--%@",responseDic,[responseDic objectForKey:@"message"]);
                
                self.promptLab.text=responseDic[@"message"];
                [self showPromptLab ];
                
                if ([responseDic[@"success"] boolValue]) {
                    
                }
            } errorHandler:^(NSError *error) {
                self.promptLab.text=@"收藏失败";
                [self showPromptLab ];
            }];
            
    
            
        }else
        {
            UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
            alert.tag=111;
            [alert show];
            
            return;
            
        }
    }
}

- (QzMessageToolBar *)chatToolBar
{
    if (_chatToolBar == nil) {
        _chatToolBar = [[QzMessageToolBar alloc] initWithFrame:CGRectMake(0, SCREEN_HEIGHT - [QzMessageToolBar defaultHeight], SCREEN_WIDTH, [QzMessageToolBar defaultHeight])];
        _chatToolBar.autoresizingMask = UIViewAutoresizingFlexibleTopMargin | UIViewAutoresizingFlexibleRightMargin;
        _chatToolBar.delegate = self;
    }
    
    return _chatToolBar;
}

-(void)initToolBar
{
    //TODO: 测试使用 正式需修改
    SDBBSDetailBottomView *bottomView=[[SDBBSDetailBottomView alloc] initWithFrame:CGRectMake(0, SCREEN_HEIGHT - QZMake(50), SCREEN_WIDTH, QZMake(50))];
    bottomView.btnDelegate = self;
    [self.view addSubview:bottomView];
    self.bottomView=bottomView;
    
    if(self.detailDic[@"isComment"] && ![self.detailDic[@"isComment"] isKindOfClass:[NSNull class]])
    {
        NSInteger isComment=[self.detailDic[@"isComment"] integerValue];
        if (isComment == 2) {//1为吐槽 2为赞
            self.bottomView.bottomBtn1.selected = YES;
        }else if (isComment ==1)
        {
            self.bottomView.bottomBtn2.selected = YES;
        }
    }
}

-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (alertView.tag==111) {
        if (buttonIndex==1) {
            [PublicMethod gotoLoginWithVC:self];
        }
    }
}

#pragma mark - 发送消息相关 chatToolBarDelegate

-(void)inputTextViewDidBeginEditing:(XHMessageTextView *)messageInputTextView
{
    //添加手势事件
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(tap:)];
    tap.numberOfTapsRequired = 1;
    tap.delegate=self;
    [self.view addGestureRecognizer:tap];
    
    
}
-(void)didSendText:(NSString *)text
{
    [self.chatToolBar endEditing:YES];
    
    if (!ISLOGIN) {//未登录
        UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
        alert.tag=111;
        [alert show];
        return;
    }
    
    [self sendBtnActionWithText:text];
}

-(void)sendBtnActionWithText:(NSString *)text
{
    [ShareFunction showHUD];
    NSMutableDictionary *tempDic=[[NSMutableDictionary alloc]init];
    [tempDic setObject:[NSString stringWithFormat:@""] forKey:@"title"];
    
    NSString *contentStr=[NSString stringWithFormat:@"%@",text];
    
    if (self.forumId) {
        
        //转gbk
        [tempDic setObject:contentStr forKey:@"content"];
        [tempDic setObject:self.forumId forKey:@"forumId"];
        [tempDic setObject:self.topicId forKey:@"topicId"];
        [tempDic setObject:self.detailDic[@"postTypeId"]  forKey:@"postTypeId"];
        [tempDic setObject:LUNTANUSERID forKey:@"userId"];
        [tempDic setObject:DEVICEUUID forKey:@"imie"];
        
        NSLog(@"发送评论=%@",tempDic);
        [[MKHttpExchangeDemo shareMyInstance] postReplyExchangeInfoWithDic:tempDic completionHandler:^(id responseObject) {
            NSDictionary *responseDic=responseObject;
            NSLog(@"回复--%@   --》%@",responseDic,responseDic[@"message"]);
            
            if ([responseDic[@"success"] intValue]==1) {
                NSDictionary *dic=[responseDic[@"datasource"] lastObject];
                
                NSString *text1=nil;
                NSString *text2=nil;
                NSString *text3=nil;
                text1=responseDic[@"message"];
                if([dic[@"replyPoint"] intValue]>0)
                {
                    text2=[NSString stringWithFormat:@"经验+%@",dic[@"replyPoint"]];
                }
                
                if([dic[@"replyPrestige"] intValue]>0)
                {
                    text2=[NSString stringWithFormat:@"积分+%@",dic[@"replyPrestige"]];
                }
                
                [ShareFunction hiddenHUD];
                [ShareFunction showToastWithText1:text1 andText2:text2 andText3:text3 inSuperview:self.view.window];
            }else{
                [ShareFunction hiddenHUD];
                [ShareFunction showAlertWithText:responseDic[@"message"]];
                
            }
            
            
            //重新请求
            [self requestBBSData ];
        } errorHandler:^(NSError *error) {
            
        }];
    }
}
#pragma mark  手势

-(BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldReceiveTouch:(UITouch *)touch
{
    //如果正在编辑 则手势 不响应点击图片的 响应回收键盘的手势
    if ([self.chatToolBar.inputTextView isFirstResponder]) {
        if ([gestureRecognizer.view isKindOfClass:[UIImageView class]]) {
            return NO;
        }
        
        if ([gestureRecognizer.view isKindOfClass:[UIView class]]) {
            return YES;
        }
    }
    return YES;
}

-(void)tap:(UIGestureRecognizer *)gesture
{
    
    [self.view removeGestureRecognizer:gesture];
    [self.chatToolBar endEditing:YES];
    
}


#pragma mark bottomViewDelegate 
-(void)bottomBtnClick:(UIButton *)sender
{
    
    
    if (!ISLOGIN) {//未登录
        UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"您尚未登录,是否去登录" delegate:self cancelButtonTitle:@"否" otherButtonTitles:@"是", nil];
        alert.tag=111;
        [alert show];
        return;
    }

    if(sender.tag == 1000)//赏个多币
    {
        NSDictionary *dic=@{@"userId": (LUNTANUSERID ? LUNTANUSERID : @""),
                            @"topicId": self.topicId,//楼主id
                            @"type":@"2"//点赞
                            };
        [AFHTTPClient getJSONPath:SDINTERFACE_appComment httpHost:BBS_IP params:dic success:^(id json) {
         
            NSDictionary *resultDic=[AFHTTPClient jsonTurnToDictionary:json];
            NSLog(@"%@------点赞",resultDic);
            
            if(resultDic[MESSAGE])
            {
                [ShareFunction showMessageMiddle:resultDic[MESSAGE]];
            }
            if(resultDic[SUCCESS])
            {
                if ([resultDic[SUCCESS] integerValue]==1) {
                     self.bottomView.bottomBtn1.selected = YES;
                }
            }
            
           

        } fail:^{
            
        }];
        
    }else if(sender.tag ==1001)//吐个槽
    {
        NSDictionary *dic=@{@"userId": (LUNTANUSERID ? LUNTANUSERID : @""),
                            @"topicId": self.topicId,//楼主id
                            @"type":@"1"//点赞
                            };
        [AFHTTPClient getJSONPath:SDINTERFACE_appComment httpHost:BBS_IP params:dic success:^(id json) {
            
            NSDictionary *resultDic=[AFHTTPClient jsonTurnToDictionary:json];
            NSLog(@"%@------踩",resultDic);
            
            if(resultDic[MESSAGE])
            {
                [ShareFunction showMessageMiddle:resultDic[MESSAGE]];
            }
            
            if(resultDic[SUCCESS])
            {
                if ([resultDic[SUCCESS] integerValue]==1) {
                    self.bottomView.bottomBtn2.selected = YES;
                }
            }
            
            
        } fail:^{
            
        }];
        
    }else if (sender.tag==1002)//我要评论
    {
        self.chatToolBar.frame =self.bottomView.frame;
        [self.view addSubview:self.chatToolBar];
    }
}


#pragma mark

-(void)initBBSTableView
{
    if(self.bbsDetailTableView)
        self.bbsDetailTableView=nil;
//    self.view.backgroundColor = LIGHT_GRAY_COLOR;
    if(self.bbsHotDataArr.count>0)
    {
        self.bbsDetailTableView = [[UITableView alloc] initWithFrame:CGRectMake(0, STAR_Y,SCREEN_WIDTH, SCREEN_HEIGHT- 64-40) style:1];
    }else
        self.bbsDetailTableView = [[UITableView alloc] initWithFrame:CGRectMake(0, STAR_Y,SCREEN_WIDTH, SCREEN_HEIGHT- 64-40) style:0];

    self.bbsDetailTableView.dataSource = self;
    self.bbsDetailTableView.delegate = self;
    if (IOS7_OR_LATER) {
        [self.bbsDetailTableView setSeparatorInset:UIEdgeInsetsZero];
    }
    self.bbsDetailTableView.backgroundColor = [UIColor clearColor];
    self.bbsDetailTableView.separatorStyle=UITableViewCellSeparatorStyleNone;
    [self.view addSubview:self.bbsDetailTableView];
    
    
    //head 存放楼主的帖子内容
    headView=[[UIView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 100)];
    headView.backgroundColor=[UIColor whiteColor];
    
    //头像
    UIImageView *headerView1=[[UIImageView alloc]initWithFrame:CGRectMake(15, 5+20, 35, 35)];
    headerView1.image=[UIImage imageNamed:@"morentouxiangMan.png"];
    headerView1.layer.cornerRadius=5;
    headerView1.layer.masksToBounds = YES;
    headerView1.userInteractionEnabled=YES;
    [headerView1 addGestureRecognizer:[[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(headViewTap:)]];
    [headView addSubview:headerView1];
    
    
    
    UILabel *nameLab=[[UILabel alloc]initWithFrame:CGRectMake(60, 5+20, 300, 20)];
    nameLab.backgroundColor=[UIColor clearColor];
    NSString *nameStr=@"***";
    if (self.detailDic[@"nickname"] && ![self.detailDic[@"nickname"] isKindOfClass:[NSNull class]] ) {
        nameStr=self.detailDic[@"nickname"];
    }
    
    if ([self.detailDic[@"isShowName"] isEqualToString:@"1"]) {
        nameStr = @"匿名";
    }
    nameLab.text=nameStr;
    nameLab.font=fontWithSize(15);
    nameLab.textColor=[UIColor darkGrayColor];
    [headView addSubview:nameLab];
    
    // 性别位置
    UIImageView *userSexImageView=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"BBSList_Man.png"]];
    userSexImageView.frame=CGRectMake(headerView1.right-22, headerView1.bottom-19, 22, 19);//头像右下角
    
    UIImage *headImage=nil;
    if (![self.detailDic[@"sex"] isKindOfClass:[NSNull class]]) {
        if ([self.detailDic[@"sex"] isEqualToString:@"0"]) {
            userSexImageView.image=UIImageByName(@"BBSList_Woman.png");
            headImage=UIImageByName(@"morentouxiangWoman.png");
        }else{
            userSexImageView.image=UIImageByName(@"BBSList_Man.png");
            headImage=UIImageByName(@"morentouxiangMan.png");
        }
    }else headImage=UIImageByName(@"morentouxiangMan.png");
    headerView1.image=headImage;
    
    // 链接地址 的头像
    [headerView1 sd_setImageWithURL:[NSURL URLWithString:self.detailDic[@"headImage"]] placeholderImage:headImage];
    
    [headView addSubview:userSexImageView];
    
    // 计算名称长度
    CGSize nameLabelsize = [nameStr sizeWithFont:nameLab.font constrainedToSize:CGSizeMake(210,21) lineBreakMode:NSLineBreakByCharWrapping];
    
    // 楼主
    UIImageView *bbslouzhu=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"BBS_louzhu.png"]];
    bbslouzhu.frame=CGRectMake(nameLab.left+nameLabelsize.width,nameLab.top, 25, 19);
    [headView addSubview:bbslouzhu];
    
    // 推荐
    UIButton *tuijianBtn=[UIButton buttonWithType:0];
    tuijianBtn.frame=CGRectMake(SCREEN_WIDTH-25, nameLab.top, 16, 21);
    [tuijianBtn setImage:UIImageByName(@"BBS_tuijian1.png") forState:UIControlStateNormal];
    tuijianBtn.hidden=YES;
    [headView addSubview:tuijianBtn];
    //是否推荐
    if(self.detailDic[@"styleColor"] && [self.detailDic[@"styleColor"] length] ==6 && [self.detailDic[@"styleColor"] isEqualToString:@"FF0000"])
    {
        tuijianBtn.hidden=NO;
    }else tuijianBtn.hidden=YES;
    
    
    // 积分等级
    UIImageView *bbsdengji=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"BBS_dengji_1.png"]];
    bbsdengji.frame=CGRectMake(nameLab.left, nameLab.bottom+2, 25*3/4., 20*3/4.);
    [headView addSubview:bbsdengji];
    
    if (self.detailDic[@"groupId"]) {
        NSString *imageName=[NSString stringWithFormat:@"BBS_dengji_%@",self.detailDic[@"groupId"]];
        bbsdengji.image=UIImageByName(imageName);
    }
    
    // 等级头衔文字
    if (self.detailDic[@"groupName"]) {
        UILabel *dengJiLab=FastCreatLabel(CGRectMake(bbsdengji.right +5, nameLab.bottom, 300, 20), [UIColor lightGrayColor], [UIFont systemFontOfSize:13], [UIColor clearColor], NSTextAlignmentLeft);
        dengJiLab.text=self.detailDic[@"groupName"];
        [headView addSubview:dengJiLab];
        
        if (self.detailDic[@"sex"] && [self.detailDic[@"sex"] isEqualToString:@"0"]) {
            // 女一个颜色
            dengJiLab.textColor=UICOLOR_RGB(251, 135, 158);
        }else{
            // 男一个颜色
            dengJiLab.textColor=UICOLOR_RGB(86, 217, 250);
        }
    }
    
    // 计算等级头衔长度
    CGSize dengJiLabelsize = [self.detailDic[@"groupName"] sizeWithFont:[UIFont systemFontOfSize:16] constrainedToSize:CGSizeMake(300,20) lineBreakMode:NSLineBreakByCharWrapping];
    
    // 时间
    UILabel *timeLab=[[UILabel alloc]initWithFrame:CGRectMake(bbsdengji.right +5 +dengJiLabelsize.width+5, 25+20, 300, 20)];
    timeLab.backgroundColor=[UIColor clearColor];
    timeLab.text=[PublicMethod intervalSinceNow:self.detailDic[@"createTime"]];
    timeLab.font=[UIFont systemFontOfSize:13];
    timeLab.textColor=[UIColor lightGrayColor];
    [headView addSubview:timeLab];
    
    //精华
    UIButton *jingHuaBtn=[UIButton buttonWithType:0];
    jingHuaBtn.frame=CGRectMake(17, 50+20, 16, 21);
    [jingHuaBtn setImage:UIImageByName(@"BBS_jinghua1.png") forState:UIControlStateNormal];
    jingHuaBtn.hidden=YES;
    [headView addSubview:jingHuaBtn];
    
    
    // 标题
    UILabel *titleLab=[[UILabel alloc]initWithFrame:CGRectMake(15, 50+20, SCREEN_WIDTH - 30, 20)];
    titleLab.backgroundColor=[UIColor clearColor];
    titleLab.textColor=[UIColor colorWithRed:0 green:0 blue:0 alpha:0.9];
    titleLab.font=[UIFont systemFontOfSize:17];
    titleLab.text=self.detailDic[@"title"];
    titleLab.numberOfLines=0;
    [headView addSubview:titleLab];
    
    
    //判断是否是精华
    if (self.detailDic[@"jinghua"] && [self.detailDic[@"jinghua"] intValue]>0)
    {
        jingHuaBtn.hidden=NO;
        
        titleLab.text=[NSString stringWithFormat:@"    %@",self.detailDic[@"title"]];
    }else
    {
        jingHuaBtn.hidden=YES;
    }
    if (self.isZhiDingTie) {
        titleLab.font=[UIFont systemFontOfSize:18];
    }
    
    //调整标题的高度
    CGSize titleLabsize = [titleLab.text sizeWithFont:titleLab.font constrainedToSize:CGSizeMake(SCREEN_WIDTH-30,2000) lineBreakMode:NSLineBreakByCharWrapping];
    CGRect titleLabFrame=titleLab.frame;
    titleLab.frame=CGRectMake(titleLabFrame.origin.x, titleLabFrame.origin.y, SCREEN_WIDTH-30, titleLabsize.height);
    
    
    
    CGFloat begin_y=titleLab.bottom+15;
    
    firstBegin_Y=begin_y;
    
    NSArray *contentArr=self.detailDic[@"contentArr"];
    
    BOOL firstImage=YES;
    int firstIndex=0;
    for (int i=0; i<contentArr.count; i++) {
        
        // 文本
        if ([contentArr[i][@"type"] isEqualToString:@"text"]) {
            
            NSString *contentString=contentArr[i][@"content"];
            
            // 内容
            UILabel *contentLab=[[UILabel alloc]initWithFrame:CGRectMake(15, begin_y,SCREEN_WIDTH-30, 20)];
            contentLab.backgroundColor=[UIColor clearColor];
            contentLab.textColor=[UIColor colorWithRed:0 green:0 blue:0 alpha:0.7];
            contentLab.font=[UIFont systemFontOfSize:15];
            contentLab.text=contentString;
            contentLab.numberOfLines=0;
            [headView addSubview:contentLab];
            
            // 如果是置顶帖
            if (self.isZhiDingTie) {
                contentLab.font=[UIFont systemFontOfSize:17];
            }
            
            
            NSMutableParagraphStyle *paragraphStyle = [[NSMutableParagraphStyle alloc] init];
            [paragraphStyle setLineSpacing:5];//调整行间距
            
            
            NSMutableAttributedString *str = [[NSMutableAttributedString alloc] initWithString:contentString];
            [str addAttribute:NSParagraphStyleAttributeName value:paragraphStyle range:NSMakeRange(0, [contentString length])];
            
            contentLab.attributedText = str;
            [contentLab sizeToFit];
            
            
            headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, contentLab.bottom+5);
            begin_y =CGRectGetMaxY(contentLab.frame)+5;
            
            
            
            [self.contentLabAndImageArr addObject:contentLab];
            
        }else if([contentArr[i][@"type"] isEqualToString:@"img"])
        {
            if (firstImage) {
                firstIndex=i;
                firstImage=NO;
            }
            
            QzImageView *imageView=[[QzImageView alloc]initWithFrame:CGRectMake(10, begin_y, SCREEN_WIDTH-20, SCREEN_WIDTH-20)];
            imageView.backgroundColor=LIGHT_GRAY_COLOR;
            imageView.userInteractionEnabled=YES;
            [headView addSubview:imageView];
            
 
            headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y + SCREEN_WIDTH-20 +5);
            begin_y +=SCREEN_WIDTH-20  +5;
            
            
            [self.contentLabAndImageArr addObject:imageView];
        }
        
        
    }
    
  
    //底部头像
    headBottomView=[[UIView alloc] initWithFrame:CGRectMake(0, headView.height, SCREEN_WIDTH, QZMake(40))];
    [headView addSubview:headBottomView];
    
    self.commentArray = [[NSMutableArray alloc] initWithArray:self.detailDic[@"commentUsers"]];
    
    UIButton *moreBtn=[UIButton buttonWithType:0];
    moreBtn.frame = CGRectMake(SCREEN_WIDTH-QZMake(40), 0, QZMake(35), QZMake(35));
    [moreBtn setImage:[UIImage imageNamed:@"btn_more"] forState:UIControlStateNormal];
    moreBtn.centerY=headBottomView.height/2.;
    [headBottomView addSubview:moreBtn];
    
    
    for (int i=0; i<self.commentArray.count; i++) {
        
        if (i<5) {
            UIButton *btn=[UIButton buttonWithType:0];
            btn.frame = CGRectMake(SCREEN_WIDTH-QZMake(40)*(i +2), 0, QZMake(35), QZMake(35));
            [btn sd_setImageWithURL:self.commentArray[i] forState:UIControlStateNormal placeholderImage:[UIImage imageNamed:@"morentouxiangMan"]];
            [headBottomView addSubview:btn];
            
            btn.centerY = headBottomView.height/2.;
            [btn qzSetCornerRadius:btn.width/2.];
            
            
        }else
        {
            break;
        }

    }
    
    headView.height +=QZMake(40);

    //画白线
    UIImageView *line1=[[UIImageView alloc]initWithFrame:CGRectMake(0, headView.height-0.5, SCREEN_WIDTH, 0.5)];
    line1.backgroundColor=[UIColor lightGrayColor];
    line1.qzTagString = @"bottomLine";
    [headView addSubview:line1];
    
    self.bbsDetailTableView.tableHeaderView = headView;
    
    //下载图片
    imageIndex=0;
    
    //去下载第一个图片
    if(!firstImage)
    {
        [self downImageWithIndex:firstIndex];
    }
    
    
    
    // 1.下拉刷新
    [self.bbsDetailTableView addHeaderWithTarget:self action:@selector(headerRereshing)];
    
    // 2.上拉加载更多(进入刷新状态就会调用self的footerRereshing)
    [self.bbsDetailTableView addFooterWithTarget:self action:@selector(footerRereshing)];
    
    //返回顶端的按钮 1
    goTopView=[[GoTopView alloc] initWithFrame:CGRectMake(SCREEN_WIDTH-60, SCREEN_HEIGHT, 44, 44)];
    goTopView.targetScrollView = self.bbsDetailTableView;
    goTopView.distanceByBottom = 100;
    [self.view addSubview:goTopView];
    
}


-(void)headerRereshing
{
    
    [self requestBBSData];
//    [self performSelector:@selector(hearderRereshingEnd) withObject:nil afterDelay:1];
}
-(void)hearderRereshingEnd
{
    // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
    [self.bbsDetailTableView headerEndRefreshing];
}

-(void)footerRereshing
{
    if (isHaveNextPage) {
        [self getMoreBBSData ];
    }else{
        // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
        [self.bbsDetailTableView footerEndRefreshing];
        self.promptLab.text=@"已加载到最后";
        [self showPromptLab];
    }
}

#pragma mark - 下载图片

-(void)downImageWithIndex:(int)index
{
    
    NSArray *contentArr=self.detailDic[@"contentArr"];
    QzImageView *imageView=(QzImageView *)self.contentLabAndImageArr[index];
    

    if (imageIndex==0) {
        imageArr=[[NSMutableArray alloc]init];
    }
    
    
    
    NSURL *imageurl=[PublicMethod bbsImgURlAndroidWithStr:contentArr[index][@"content"]] ;
    [imageView qzSetImageWithURL:imageurl placeholderImage:nil completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, NSURL *imageURL) {
        
        UITapGestureRecognizer *gesture =[[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(imageViewTap:)];
        gesture.delegate = self;

        // 可点击图片放大
        [imageView addGestureRecognizer:gesture];
        imageView.userInteractionEnabled = YES;
        
        imageView.tag=imageIndex+100;
        imageIndex++;
        //将图片 添加到数组
        if (image) {
            [imageArr addObject:image];
        }
        
        
        // 调整位置 并下载下一张图片
        [self downImageOverToFomartLabImageFrameWithIndex:index];
    }];
}

//图文混排的
-(void)downImageOverToFomartLabImageFrameWithIndex:(int)index
{
    
    CGFloat begin_y=firstBegin_Y;
    
    NSArray *contentArr=self.detailDic[@"contentArr"];
    for (int i=0; i<contentArr.count; i++) {
        
        // 文本
        if ([contentArr[i][@"type"] isEqualToString:@"text"]) {
            UILabel *contentLab=(UILabel *)self.contentLabAndImageArr[i];
            
            if (index>i) {//下载图片前面的lab 不用改变位置
                begin_y =contentLab.bottom+5;
                
            }else{// 下载图片后面的lab
                
          
                contentLab.top=begin_y;//改变该下载图片后面lab的位置
                
                begin_y =contentLab.bottom+5;
                
            }
        }
        
        // 图片
        else
            if([contentArr[i][@"type"] isEqualToString:@"img"])
            {
                UIImageView *imageView=(UIImageView *)self.contentLabAndImageArr[i];
                
                if(index>i)//下载图片 前面的图片
                {
                    begin_y =imageView.bottom+5;
                    
                }else if(index == i)//刚下载好的图片
                {
                    CGSize imageSize=imageView.image.size;
                    
                    CGFloat imageWidthAndHeight = SCREEN_WIDTH - 20;
                    CGFloat imageHeight=imageSize.width==0 ? 0 : imageSize.height*imageWidthAndHeight/imageSize.width;
                    
                    imageView.top = begin_y;
                    imageView.height = imageHeight;
                    
                    
                    begin_y +=imageHeight +5;
                    
                    
                }else // 该图片在下载好的图片的下面
                {
                    begin_y =imageView.bottom+5;
                }
            }
    }
    
    //调整headView的高度 和白线的位置
    headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y+5);
    
    headBottomView.top=headView.height;
    headView.height +=QZMake(40);
    
    UIImageView *line=(UIImageView*)[headView subViewWithQzTagString:@"bottomLine"];
    line.frame=CGRectMake(0, headView.height -0.5, SCREEN_WIDTH, 0.5);
    
    self.bbsDetailTableView.tableHeaderView = headView;
    
    if (index+1<contentArr.count) {
        //顺序下载 下一张图片
        for (int i=index+1; i<contentArr.count; i++) {
            if ([contentArr[i][@"type"] isEqualToString:@"img"]) {
                
                [self downImageWithIndex:i];
                
                return;
            }
        }
    }
    
}



#pragma mark 浏览图片
-(void)imageViewTap:(UITapGestureRecognizer*)tap
{
    int count = (int)imageArr.count;
    // 1.封装图片数据
    NSMutableArray *photos = [NSMutableArray arrayWithCapacity:count];
    for (int i = 0; i<count; i++) {
        // 替换为中等尺寸图片
        //        NSString *url = [_urls[i] stringByReplacingOccurrencesOfString:@"thumbnail" withString:@"bmiddle"];
        MJPhoto *photo = [[MJPhoto alloc] init];
        //        photo.url = [NSURL URLWithString:url]; // 图片路径
        photo.srcImageView = (UIImageView *)[headView viewWithTag:100+i]; // 来源于哪个UIImageView
        
        [photos addObject:photo];
    }
    
    // 2.显示相册
    MJPhotoBrowser *browser = [[MJPhotoBrowser alloc] init];
    browser.currentPhotoIndex = tap.view.tag-100; // 弹出相册时显示的第一张图片是？
    browser.photos = photos; // 设置所有的图片
    [browser show];
}

#pragma mark 放大头像
-(void)headViewTap:(UITapGestureRecognizer *)tap
{
    if (IS_ShowBigHead) {
        // 1.封装图片数据
        NSMutableArray *photos = [NSMutableArray arrayWithCapacity:0];
        
        MJPhoto *photo = [[MJPhoto alloc] init];
        photo.srcImageView =(UIImageView *) tap.view; // 来源于哪个UIImageView
        [photos addObject:photo];
        
        
        // 2.显示相册
        MJPhotoBrowser *browser = [[MJPhotoBrowser alloc] init];
        browser.currentPhotoIndex = 0; // 弹出相册时显示的第一张图片是？
        browser.photos = photos; // 设置所有的图片
        [browser show];
    }
    
}
#pragma mark 重新加载
    //noNetworkView 3
-(void)noNetworkViewRefreshBtnClick
{
    [self requestBBSData];
}
-(void)requestBBSData
{
    //noNetworkView 2.1
    self.noNetworkView.noNetView.hidden = YES;
    self.noNetworkView.indicator.hidden = NO;
    [self.noNetworkView.indicator setCenter:CGPointMake(SCREEN_WIDTH/2., SCREEN_HEIGHT/2.)];
    [self.noNetworkView.indicator startAnimating];
    
    
    pageIndex=1;
    NSMutableDictionary *tempDic=[[NSMutableDictionary alloc]init];
    [tempDic setObject:@"10" forKey:@"pageSize"];
    [tempDic setObject:[NSString stringWithFormat:@"%d",(int)pageIndex] forKey:@"pageNo"];
    [tempDic setObject:self.topicId forKey:@"topicId"];
    
    if (isDesc) {
        [tempDic setObject:@"1" forKey:@"desc"];
    }else{
        [tempDic setObject:@"0" forKey:@"desc"];
    }
    
    if (ISLOGIN && LUNTANUSERID) {
        [tempDic setObject:LUNTANUSERID forKey:@"userId"];
    }
    
    
   opration = [[MKHttpExchangeDemo shareMyInstance] requestPostWithURL:MKPath_appPostWithHotPostInfo andParamDic:tempDic completionHandler:^(id responseObject)
     {
         NSDictionary *responseDic =[NSDictionary dictionaryWithDictionary:responseObject];
         responseObject=nil;
         
         NSLog(@"bbsdata--<>>%@--%@ ---bbsdata",responseDic,[responseDic objectForKey:@"message"]);
         
         //贴子回复内容 加入数组
         NSDictionary *datasource=responseDic[DATASOURCE];
         if (datasource) {
             [self.bbsDataArr removeAllObjects];
             
             // 正常回复
             [PublicMethod formatRequestDataForAndroidForNvShenDaoGou:datasource[@"normalPost"] toArray:self.bbsDataArr];
            
             //最热回复
             if (datasource[@"hotPost"] )
             {
                 [PublicMethod formatRequestDataForAndroidForNvShenDaoGou:datasource[@"hotPost"] toArray:self.bbsHotDataArr];
             }
             
             if (datasource[@"mainContent"] && [datasource[@"mainContent"]isKindOfClass:[NSDictionary class]] && datasource[@"mainContent"][@"topic"]) {
                 self.detailDic=[PublicMethod formartDic: datasource[@"mainContent"][@"topic"]];//
             }
             
             
             if(self.bbsDetailTableView==nil){
                 [self initBBSTableView];
                 [self initToolBar];

             }else
                 [self.bbsDetailTableView reloadData];
                 
                 
           
             
             [self.bbsDetailTableView scrollRectToVisible:CGRectMake(0, 0, SCREEN_WIDTH, 1) animated:YES];
             
             [self JudgePageNumAndToalPage:datasource[@"normalPost"]];
             
             
         }
         
         //noNetworkView 2.2
         [self.noNetworkView.indicator stopAnimating];
         [self.noNetworkView removeFromSuperview];
         
         [self hearderRereshingEnd];
     } errorHandler:^(NSError *error) {
         
         //noNetworkView 2.3
         [self.noNetworkView.indicator stopAnimating];
         self.noNetworkView.indicator.hidden = YES;
         self.noNetworkView.noNetView.hidden = NO;
         
         [self hearderRereshingEnd];

     }];
}

-(void)getMoreBBSData
{
    pageIndex++;
    
    NSMutableDictionary *tempDic=[[NSMutableDictionary alloc]init];
    [tempDic setObject:@"10" forKey:@"pageSize"];
    [tempDic setObject:[NSString stringWithFormat:@"%d",(int)pageIndex] forKey:@"pageNo"];
    [tempDic setObject:self.topicId forKey:@"topicId"];
    if (isDesc) {
        [tempDic setObject:@"1" forKey:@"desc"];
    }
    if (ISLOGIN && LUNTANUSERID) {
        [tempDic setObject:LUNTANUSERID forKey:@"userId"];
    }
    opration=[[MKHttpExchangeDemo shareMyInstance] requestPostWithURL:MKPath_appPostWithHotPostInfo andParamDic:tempDic completionHandler:^(id responseObject)
     {
         NSDictionary *responseDic = responseObject;
         NSLog(@"--<>>%@--%@",responseDic,[responseDic objectForKey:@"message"]);
         
         //贴子回复内容 加入数组
         NSDictionary *datasource=responseDic[DATASOURCE];
         if (datasource) {
       
             [PublicMethod formatRequestDataForAndroidForNvShenDaoGou:datasource[@"normalPost"] toArray:self.bbsDataArr];
             
             
             
             [self.bbsDetailTableView reloadData];
             [self JudgePageNumAndToalPage:datasource[@"normalPost"]];
             
             // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
             [self.bbsDetailTableView footerEndRefreshing];
             
         }
     } errorHandler:^(NSError *error) {
         // (最好在刷新表格后调用)调用endRefreshing可以结束刷新状态
         [self.bbsDetailTableView footerEndRefreshing];
     }];
}
//添加触底刷新
-(void)JudgePageNumAndToalPage:(NSArray *)dataSource
{
 
    if ([dataSource count] >=9) {
        isHaveNextPage=YES;
    }else
    {
        isHaveNextPage=NO;
    }
}


-(void)clickZanBtn:(NSIndexPath *)indexPath
{
 
    if (!ISLOGIN || !LUNTANUSERID) {
        [PublicMethod gotoLoginWithVC:self];
    }else
    {
        NSDictionary *tempDic;
        if (indexPath.section == 0) {
            tempDic=@{@"postId":self.bbsHotDataArr[indexPath.row][@"id"],@"userId":LUNTANUSERID};

        }else
        {
            tempDic=@{@"postId":self.bbsDataArr[indexPath.row][@"id"],@"userId":LUNTANUSERID};

        }
        [AFHTTPClient getJSONPath:SDINTERFACE_appUserPraise httpHost:BBS_IP params:tempDic success:^(id json) {
            NSDictionary *dic=[AFHTTPClient jsonTurnToDictionary:json];
            
            NSLog(@"%@----",dic);
            if (dic[SUCCESS] && [dic[SUCCESS] intValue]==1) {
                
                if (indexPath.section ==0 ) {
                    if ([dic[MESSAGE] isEqualToString:@"cancel"]) {
                        [self.bbsHotDataArr[indexPath.row] setObject:@"0" forKey:@"isAsscoiated"];
                    }else//praise
                    {
                        [self.bbsHotDataArr[indexPath.row] setObject:@"1" forKey:@"isAsscoiated"];
                    }
                }else if(indexPath.section == 1)
                {
                    if ([dic[MESSAGE] isEqualToString:@"cancel"]) {
                        [self.bbsDataArr[indexPath.row] setObject:@"0" forKey:@"isAsscoiated"];
                    }else//praise
                    {
                        [self.bbsDataArr[indexPath.row] setObject:@"1" forKey:@"isAsscoiated"];
                    }
                }
                
                [self.bbsDetailTableView reloadData];
            }
            
            
        } fail:^{
            
        }];
    }
   
}

#pragma mark- tableView detegate
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView;
{
    return 2;
}
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    NSArray *tempArr;
    if (section ==0) {
        tempArr = self.bbsHotDataArr;
    }else
    {
        tempArr = self.bbsDataArr;
    }
    return tempArr.count;
  
}


-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    if (section == 0 &&self.bbsHotDataArr.count>0) {
        return 15;
    }
    
    return 0;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    if (section == 0 && self.bbsHotDataArr.count>0) {
        UIImageView *imageView=[UIImageView qzImageViewLineWithX:0 withY:0 withWidth:SCREEN_WIDTH withHeight:15];
        return imageView;
    }else
    {
        return nil;
    }
   
}

-(CGFloat)tableView:(UITableView *)tableView estimatedHeightForFooterInSection:(NSInteger)section
{
    if (section == 0 && self.bbsHotDataArr.count>0) {
        return 15;
    }
    return 0;
}

-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section
{
    if (section == 0 && self.bbsHotDataArr.count>0  ) {
        UIImageView *imageView=[UIImageView qzImageViewLineWithX:0 withY:0 withWidth:SCREEN_WIDTH withHeight:15];
        return imageView;
    }else
    {
        return nil;
    }
}


- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    if (self.bbsDataArr.count>0) {
        NSString *contentStr=[self.bbsDataArr[indexPath.row][@"contentArr"] firstObject][@"content"];//女神导购
        CGSize labelsize = [contentStr sizeWithFont:[UIFont systemFontOfSize:14] constrainedToSize:CGSizeMake(250,2000) lineBreakMode:NSLineBreakByCharWrapping];
        
        if (!IS_OFFBBSSecond) {
            if(self.bbsDataArr[indexPath.row][@"secondary"] && [self.bbsDataArr[indexPath.row][@"secondary"] lastObject] )
            {
                NSInteger num=[self.bbsDataArr[indexPath.row][@"secondaryCount"] integerValue];
                
                if (num>1) {
                    return 56+labelsize.height+13 +60;
                    
                }else return 56+labelsize.height+13 +30;
                
            }else  return 56+labelsize.height+13;
        }else{
            return 56+labelsize.height+13;
        }
    }else return 88;
}

//-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
//{
//    return 20;
//}
//
//-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
//{
//    UIImageView *imageView=[UIImageView qzImageViewLineWithX:0 withY:0 withWidth:SCREEN_WIDTH withHeight:20];
//    
//    return imageView;
//}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    static NSString *CellIdentifier = @"BBSDetailCell";
    BBSDetailCell *cell = (BBSDetailCell *)[tableView dequeueReusableCellWithIdentifier:CellIdentifier];
    if (cell == nil) {
        cell = [[[NSBundle mainBundle] loadNibNamed:@"BBSDetailCell" owner:self options:nil] lastObject];
        
    }
    
    cell.backgroundColor = [UIColor whiteColor];
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    
    //头像
    cell.headImage.layer.cornerRadius=5;
    cell.headImage.layer.masksToBounds = YES;
    
    
    NSArray *tempArr;
    if (indexPath.section ==0) {
        tempArr = self.bbsHotDataArr;

    }else
    {
        tempArr = self.bbsDataArr;
    }
    
    
    
    
    
    [cell configCellWithArrayForNvShenDaoGou:tempArr indexRow:indexPath];
    
    __weak typeof(self) weakSelf = self;
    cell.cellBlock =^(NSIndexPath *indexPath)
    {
        NSLog(@"点击了第%zi行 赞",indexPath);
        
        [weakSelf clickZanBtn:indexPath];
    };
    
    
    
    
    //二级回复
    if(!IS_OFFBBSSecond &&  tempArr[indexPath.row][@"secondary"] && [tempArr[indexPath.row][@"secondary"] lastObject] )
    {
      

        // 显示一条回复
        UILabel *huifu1=[[UILabel alloc]initWithFrame:CGRectMake(51,CGRectGetMaxY(cell.contentLab.frame) +2 , SCREEN_WIDTH-51, 30)];
        huifu1.text=@"测试用户：用户留言内容";
        huifu1.backgroundColor=[UIColor clearColor];
        huifu1.font=[UIFont systemFontOfSize:13];
        [cell addSubview:huifu1];
        
        
        
        
        UILabel *timeLab=[[UILabel alloc]initWithFrame:CGRectMake(51,CGRectGetMaxY(cell.contentLab.frame) +2 , SCREEN_WIDTH-10-51, 30)];
        timeLab.text=@"2015-09-23";
        timeLab.backgroundColor=[UIColor clearColor];
        timeLab.textAlignment=NSTextAlignmentRight;
        timeLab.textColor=[UIColor lightGrayColor];
        timeLab.font=[UIFont systemFontOfSize:10];
        [cell addSubview:timeLab];
        
        NSString *timeStr=@"";
        timeStr=[NSString stringWithFormat:@"%@",[PublicMethod intervalSinceNow:tempArr[indexPath.row][@"createTime"]]];
        timeLab.text=timeStr;
        
        CGSize labelsize = [timeStr sizeWithFont:[UIFont systemFontOfSize:10] constrainedToSize:CGSizeMake(250,30) lineBreakMode:NSLineBreakByCharWrapping];
        CGFloat length=labelsize.width;
        CGRect huifuRect=huifu1.frame;
        huifu1.frame=CGRectMake(huifuRect.origin.x, huifuRect.origin.y, SCREEN_WIDTH-10-51-length-2, huifuRect.size.height);
        
        NSString *secondaryContent=@"";
        if ([tempArr[indexPath.row][@"secondary"] firstObject][@"secondaryContent"]) {
            secondaryContent=[tempArr[indexPath.row][@"secondary"] firstObject][@"secondaryContent"];
        }
        
        NSString *secondaryName=@"***";
        if ([tempArr[indexPath.row][@"secondary"] firstObject][@"secondaryName"] && ![[tempArr[indexPath.row][@"secondary"] firstObject][@"secondaryName"] isKindOfClass:[NSNull class]]) {
            
            secondaryName=[NSString stringWithFormat:@"%@",[tempArr[indexPath.row][@"secondary"] firstObject][@"secondaryName"]];
        }
        
        NSString *contentAll=[NSString stringWithFormat:@"%@：%@",secondaryName,secondaryContent];
        
        //用户名加颜色
        NSMutableAttributedString *str7 = [[NSMutableAttributedString alloc] initWithString:contentAll];
        [str7 addAttribute:NSForegroundColorAttributeName value:ColorSecondName range:NSMakeRange(0,secondaryName.length+1)];
        huifu1.attributedText = str7;
        
        
        //更多评论个数
        if (tempArr[indexPath.row][@"secondaryCount"])
        {
            NSInteger num=[tempArr[indexPath.row][@"secondaryCount"] integerValue];
            
            if (num>1) {
                
                
                //背景
                UIImageView *cellBgView=[[UIImageView alloc]initWithFrame:CGRectMake(45,CGRectGetMaxY(cell.contentLab.frame) +2, SCREEN_WIDTH-50, 60)];
                
                UIImage *img=[UIImage imageNamed:@"BBSCellSecondBg"];
                img=[img stretchableImageWithLeftCapWidth:150 topCapHeight:15];
                cellBgView.image=img;
                [cell addSubview:cellBgView];
                
                
                
                UIButton *moreHuiFu=[UIButton buttonWithType:0];
                moreHuiFu.frame=CGRectMake(SCREEN_WIDTH - 120, huifu1.bottom +2, 120, 30) ;
                //    moreHuiFu.backgroundColor=[UIColor redColor];
                [moreHuiFu setTitleColor:ColorSecondName forState:0];
                //    moreHuiFu.titleLabel.textColor=[UIColor blackColor];
                [moreHuiFu setTitle:[NSString stringWithFormat:@"查看全部%d条评论",(int)num ] forState:0];
                [moreHuiFu.titleLabel setFont:[UIFont systemFontOfSize:12]];
                [moreHuiFu addTarget:self action:@selector(moreHuiFuClick:) forControlEvents:UIControlEventTouchUpInside];
                moreHuiFu.tag=indexPath.row;
                [cell addSubview:moreHuiFu];
            }else{
                
                // 背景
                UIImageView *cellBgView=[[UIImageView alloc]initWithFrame:CGRectMake(45, CGRectGetMaxY(cell.contentLab.frame) +2, SCREEN_WIDTH-50, 30)];
                
                UIImage *img=[UIImage imageNamed:@"BBSCellSecondBg"];
                img=[img stretchableImageWithLeftCapWidth:150 topCapHeight:15];
                cellBgView.image=img;
                [cell addSubview:cellBgView];
                
            }
            
        }
        
    }
    
    
    
    
    return cell;
    
}

-(void)moreHuiFuClick:(UIButton *)sender
{
    BBSDetailCellViewController *moreCellDetail=[[BBSDetailCellViewController alloc]initWithNibName:@"BBSDetailCellViewController" bundle:[NSBundle mainBundle]];
    moreCellDetail.hidesBottomBarWhenPushed=YES;
    moreCellDetail.postId=self.bbsDataArr[sender.tag][@"id"];
    moreCellDetail.detailDic=self.bbsDataArr[sender.tag];
    moreCellDetail.forumId=self.forumId;
    [self.navigationController pushViewController:moreCellDetail animated:YES];
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    
    NSArray *tempArr;
    if (indexPath.section ==0) {
        tempArr = self.bbsHotDataArr;
    }else
    {
        tempArr = self.bbsDataArr;
    }
    
    
    if (!IS_OFFBBSSecond) {
        BBSDetailCellViewController *moreCellDetail=[[BBSDetailCellViewController alloc]initWithNibName:@"BBSDetailCellViewController" bundle:[NSBundle mainBundle]];
        moreCellDetail.hidesBottomBarWhenPushed=YES;
        moreCellDetail.postId=tempArr[indexPath.row][@"id"];
        moreCellDetail.detailDic=tempArr[indexPath.row];
        moreCellDetail.forumId=self.forumId;
        moreCellDetail.isFirstShowKeyboard=YES;
        [self.navigationController pushViewController:moreCellDetail animated:YES];
    }
    
    
    
}


#pragma mark -
#pragma mark UIScrollViewDelegate Methods


- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    
    
    //返回顶端的按钮 3
    [goTopView scrollViewDidScroll:scrollView];
    
    
}






//显示提示
-(void)showPromptLab
{
    [self.view addSubview:self.promptLab];
    [UIView animateWithDuration:1.0 delay:0.0 options:UIViewAnimationOptionCurveEaseIn animations:^{self.promptLab.alpha = 0.6;} completion:nil];
    [self performSelector:@selector(dismissPromptLab) withObject:nil afterDelay:0.0];
}
//提示消失
-(void)dismissPromptLab
{
    [UIView animateWithDuration:1.0 delay:1.0 options:UIViewAnimationOptionCurveEaseIn animations:^{self.promptLab.alpha = 0.0;} completion:^(BOOL finished) {
        [self.promptLab removeFromSuperview];
    }];
}


- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    
    
}

@end


