//
//  GoodsDetailTwoViewController.m
//  sexduoduo
//
//  Created by dsz on 15-4-17.
//  Copyright (c) 2015年 dbCode. All rights reserved.
//

#import "GoodsDetailTwoViewController.h"
#import "MJRefresh.h"
#import "SDGoodsDetailBottomView.h"
#import "CouponsViewController.h"

#import "SDGoodRecommendObj.h"
#import "SDGoodDetailRecommend.h"

#import "SDGoodCommentView.h"
@interface GoodsDetailTwoViewController ()
{
    NSString *alipayMinPriceStr;
    NSString *huoDaoMinPriceStr;
    
    CustomGoodsDetailSegment *segmentedControl;
    UIView *segmentedControlView;
    CGFloat scViewPointY;
    
    BOOL isBack;
}
@property (nonatomic, strong)SDGoodDetailRecommend *recommendView;//商品推荐或者 套餐组合View
@property (nonatomic, strong)NSMutableArray *recommendArr;
@property (nonatomic, assign)BOOL isRecommendGroup;

@property (nonatomic, strong)SDGoodCommentView *commentView;//商品推荐或者 套餐组合View


@end

@implementation GoodsDetailTwoViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
        
        alipayMinPriceStr = @"88";
        huoDaoMinPriceStr = @"188";
        
        [self judgeUmengOnline];
    }
    return self;
}
-(void)dealloc
{
    
}

-(void)judgeUmengOnline
{
    //显示的view
    alipayMinPriceStr = @"88";
    NSString* isAlipayMinPriceStr = [MobClick getConfigParams:@"alipayMinPriceStr"];
    if (isAlipayMinPriceStr) {
        alipayMinPriceStr=isAlipayMinPriceStr;
    }
    
    huoDaoMinPriceStr = @"188";
    NSString* isHuoDaoMinPriceStr = [MobClick getConfigParams:@"huoDaoMinPriceStr"];
    if (isHuoDaoMinPriceStr) {
        huoDaoMinPriceStr=isHuoDaoMinPriceStr;
    }
}


- (void)viewDidLoad
{
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
  
    self.view.width = SCREEN_WIDTH;
    if (IOS7_OR_LATER) {
        self.edgesForExtendedLayout = UIRectEdgeNone;
    }
    
    self.indicator.centerX= SCREEN_WIDTH/2.;
    
    self.commentArray = [NSMutableArray arrayWithCapacity:0];//评论
    self.detailImageStrArray =[NSMutableArray arrayWithCapacity:0];//详情的图片路径array
    self.recommendArray = [NSMutableArray arrayWithCapacity:0];//相关推荐
    
    currentPage=1;
    
    _colorArray = [NSMutableArray arrayWithCapacity:0]; //规格
    self.imagesArray = [NSMutableArray arrayWithCapacity:0];//广告图

    
    [self setTopNavView];
    
    //请求商品详情
    NSDictionary *params = [[NSDictionary alloc]init];
    params = @{@"goodId":self.goodsIdStr};
    NSLog(@"请求商品详情-->%@",params);
    [self requestGoodsDetailWithDic:params];
    

    
    // 统计商品详情进入次数
    [MobClick event:@"Goods_Info"];

    
    // 立即购买 加入购物车
    SDGoodsDetailBottomView *bottomView=[[SDGoodsDetailBottomView alloc] initWithFrame:CGRectMake(0, SCREEN_HEIGHT - MAKEOF5(50), SCREEN_WIDTH, MAKEOF5(50))];
    bottomView.mainVC = self;
    [self.primaryView addSubview:bottomView];
    
}


-(void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    
    //刷新购物车数目
   int shopCarNum= [[ShopCarObj shareInstance] shopGoodsNum];
   self.numLabel.text = [NSString stringWithFormat:@"%d",shopCarNum];
}

-(void)viewDidDisappear:(BOOL)animated
{
    [super viewDidDisappear:animated];
    
    //1。取消网络下载过程
    [opration cancel];
    [oprationTuWen cancel];
    [oprationTuiJian cancel];
    [oprationPingLun cancel];
    
    //2.取消图文详情的下载
    NSArray *subArray=[self.productDetailView subviews];
    for (int i=0; i<subArray.count; i++) {
        if ([subArray[i] isKindOfClass:[QzImageView class]]) {
            QzImageView *imageView=subArray[i];
            [imageView qzCancelCurrentImageLoad];
        }
    }
}

//顶部NavView
-(void)setTopNavView
{
    int imgY = -20;
    if (IOS7_OR_LATER) {
        imgY = 0;
    }
    
    TopNavView *navView=[[TopNavView alloc] initWithFrame:CGRectMake(0, imgY,SCREEN_WIDTH, 64)];
    [self.view addSubview:navView];
    
    [navView addLeftBtnTarget:self action:@selector(toBackView) forControlEvents:UIControlEventTouchUpInside];
    
    [navView setTitleStr:@"商品详情"];
    
    
    
    self.shopCarBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    self.shopCarBtn.frame = CGRectMake(SCREEN_WIDTH - 47, 20 , 44, 44);
    [self.shopCarBtn setImage:[UIImage imageNamed:@"addShopCarImg.png"] forState:UIControlStateNormal];
    [self.shopCarBtn setImage:[UIImage imageNamed:@"addShopCarImg.png"] forState:UIControlStateSelected];
    [self.shopCarBtn addTarget:self action:@selector(toShopCarView:) forControlEvents:UIControlEventTouchUpInside];
    [navView addSubview:self.shopCarBtn];
    
    
    
    
    UIImageView *numImg = [[UIImageView alloc] initWithFrame:CGRectMake(SCREEN_WIDTH - 25, 22 , 17, 17)];
    [numImg setImage:[UIImage imageNamed:@"numBg.png"]];
    [navView addSubview:numImg];
    
    self.numLabel = [[UILabel alloc] initWithFrame:numImg.frame];
    self.numLabel.font = [UIFont systemFontOfSize:8.0];
    self.numLabel.textColor = WHITE_COLOR;
    self.numLabel.textAlignment = NSTextAlignmentCenter;
    self.numLabel.text = @"0";
    self.numLabel.backgroundColor = [UIColor clearColor];
    [navView addSubview:self.numLabel];
}




#pragma mark 商品规格选择view 设置图片 价格 名称

-(void)initColorChooseView
{
    self.goodColorChooseView = [[SDGoodsDetailChooseColorView alloc] initWithFrame:CGRectMake(0, self.primaryView.frame.size.height, SCREEN_WIDTH, MAKEOF5(382))];

    self.goodColorChooseView.mainVC = self;
    [self.view addSubview:self.goodColorChooseView];
    
    UIView *line1 = [[UIView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 0.5)];
    line1.backgroundColor = [UIColor lightGrayColor];
    [self.goodColorChooseView addSubview:line1];
    
    
    // 键盘上面的 输入辅助view
    UIView *popV1 = [[UIView alloc]initWithFrame:CGRectMake(0, 0,SCREEN_WIDTH, 30)];
    popV1.backgroundColor = [UIColor colorWithRed:244/255.f green:244/255.f blue:244/255.f alpha:1.0];
    UIButton *btn1 = [UIButton buttonWithType:UIButtonTypeCustom];
    [btn1 setTitle:@"完成" forState:UIControlStateNormal];
    //    [btn setBackgroundImage:[UIImage imageNamed:@"keyboard_down.png"] forState:UIControlStateNormal];
    [btn1 setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
    [btn1 addTarget:self action:@selector(goodsNumChoose:) forControlEvents:UIControlEventTouchUpInside];
    btn1.frame = CGRectMake(SCREEN_WIDTH-46, 0, 46, 30);
    [popV1 addSubview:btn1];
    self.goodColorChooseView.goodsNumField.inputAccessoryView = popV1;
    
    if(judgeUrlIsHave(self.goodsDetailDic, @"newThumbnailGoodsImagePath"))
    {
        [self.goodColorChooseView.productImg sd_setImageWithURL:[NSURL URLWithString:[self.goodsDetailDic objectForKey:@"newThumbnailGoodsImagePath"]] placeholderImage:nil];
    }else
    {
        [self.goodColorChooseView.productImg sd_setImageWithURL:[PublicMethod imgWithUrl:[self.goodsDetailDic objectForKey:@"ThumbnailGoodsImagePath"]] placeholderImage:nil];
    }
    self.goodColorChooseView.productPrice.text = [NSString stringWithFormat:@"￥%.2f",[[self.goodsDetailDic objectForKey:@"goods_price"] floatValue]];
    self.goodColorChooseView.productColor.text = [NSString stringWithFormat:@"%@",[self.goodsDetailDic objectForKey:@"name"]];
    
    self.promptLab = [[UILabel alloc] initWithFrame:CGRectMake(0, STAR_Y, SCREEN_WIDTH, 35)];
    self.promptLab.backgroundColor = [UIColor blackColor];
    self.promptLab.alpha = 0.0;
    self.promptLab.font = [UIFont systemFontOfSize:14.0];
    self.promptLab.textColor = [UIColor whiteColor];
    self.promptLab.textAlignment = NSTextAlignmentCenter;
    self.promptLab.center=self.view.center;//提示框在中间
    [self.view addSubview:self.promptLab];
    
    
}


#pragma mark - 初始化总的ScrollView
-(void)initDetailScrollView
{
    
    self.detailScrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0,STAR_Y,SCREEN_WIDTH, [UIScreen mainScreen].bounds.size.height - STAR_Y - MAKEOF5(50) - OFFSET_Y)];
    
    [self.primaryView addSubview:self.detailScrollView];
    
    
    headView =[[UIView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_WIDTH +10 +topViewH)];
    headView.userInteractionEnabled = YES;
    
    [self.detailScrollView addSubview:headView];
    
    
    //TopPicScView
    [self initTopPicScrollView];
    
    [self initTitleView];
    

    
    //推荐商品 套餐组合
//    [self initRecommendView];
    
    //评论
    [self initCommentView];
    
    
    // 详情 图片
    [self initDetailPicView];
    
    [self formartFrame];
    
}

#pragma mark  商品规格选择 效果设计
- (void)setupGridView{
    
    self.goodColorChooseView.colorArray = self.colorArray ;
    [self.goodColorChooseView setupGridView];
    
}


-(void)formartFrame
{
    if (self.commentView) {
        if (self.recommendView) {
            self.recommendView.top = SCREEN_WIDTH + 10 + topViewH;
            self.commentView.top = self.recommendView.bottom+10;
            
        }else self.commentView.top = SCREEN_WIDTH + 10 + topViewH;
        
        
        headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, self.commentView.bottom);

    }else
    {
        
        if (self.recommendView) {
            self.recommendView.top = SCREEN_WIDTH + 10 + topViewH;
            //没有评论 有推荐商品 已推荐商品的底部 为高度
            headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, self.recommendView.bottom);
        }else
        {
            headView.frame=CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_WIDTH + 10 + topViewH);
        }
        
    }
    
    
    self.productDetailView.top = headView.bottom;
    
    self.detailScrollView.contentSize = CGSizeMake(SCREEN_WIDTH, self.productDetailView.bottom);
}


#pragma mark  中间商品标题部分 包邮提示 正品提示
-(void)initTitleView
{
    UIView *titleView = [[UIView alloc] initWithFrame:CGRectMake(0, SCREEN_WIDTH+10,SCREEN_WIDTH, 160)];
    titleView.backgroundColor = [UIColor clearColor];
    [headView addSubview:titleView];
    titleView.userInteractionEnabled = YES;
    
    int layOutH = 0;
    
    layOutH += 10;
    
    CGSize detailSize = [[self.goodsDetailDic objectForKey:@"name" ] sizeWithFont:[UIFont systemFontOfSize:16.0]
                                                                constrainedToSize:CGSizeMake(SCREEN_WIDTH - MAKEOF5(45), 60)
                                                                    lineBreakMode:NSLineBreakByWordWrapping];
    
    UILabel *titleLab = [[UILabel alloc] initWithFrame:CGRectMake(10, layOutH, SCREEN_WIDTH - MAKEOF5(45), detailSize.height)];

    titleLab.backgroundColor = [UIColor clearColor];
    titleLab.text = [NSString stringWithFormat:@"%@",[self.goodsDetailDic objectForKey:@"name" ]];
    titleLab.numberOfLines = 0;
    titleLab.font = [UIFont systemFontOfSize:16.0];
    titleLab.textColor = [UIColor grayColor];
    [titleView addSubview:titleLab];
    
    
    collectBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    collectBtn.frame = CGRectMake(SCREEN_WIDTH - MAKEOF5(45), layOutH -5 , 44, 44);
    //    [rightBtn setTitle:@"next" forState:UIControlStateNormal];
    //    [rightBtn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    [collectBtn setImage:[UIImage imageNamed:@"goodDetailUncollect"] forState:UIControlStateNormal];
    [collectBtn setImage:[UIImage imageNamed:@"goodDetailCollected"] forState:UIControlStateSelected];
    [collectBtn addTarget:self action:@selector(collectGoodsAction) forControlEvents:UIControlEventTouchUpInside];
    [titleView addSubview:collectBtn];
    
    
    layOutH = detailSize.height + 5 + layOutH;
    
    UILabel *numLab = [[UILabel alloc] initWithFrame:CGRectMake(SCREEN_WIDTH -10- 100, layOutH + 5, 100, 20)];
    numLab.backgroundColor = [UIColor clearColor];
    numLab.textColor = [UIColor grayColor];
    numLab.textAlignment = NSTextAlignmentRight;
    numLab.font = [UIFont systemFontOfSize:12.0];
    numLab.text = [NSString stringWithFormat:@"月销量%@件",[self.goodsDetailDic objectForKey:@"salesVolume"]];
    [titleView addSubview:numLab];
    
    
    CGSize detailPriceSize = [[NSString stringWithFormat:@" ￥%.2f",[[self.goodsDetailDic objectForKey:@"goods_price"] floatValue]] sizeWithFont:[UIFont boldSystemFontOfSize:20.0]
                                                                                                                              constrainedToSize:CGSizeMake(200, 20)
                                                                                                                                  lineBreakMode:NSLineBreakByWordWrapping];
    
    
    UILabel *priceLab = [[UILabel alloc] initWithFrame:CGRectMake(5, layOutH + 5, detailPriceSize.width, 20)];
    priceLab.backgroundColor = [UIColor clearColor];
    priceLab.textColor = NAV_RED_COLOR;
    priceLab.font = [UIFont boldSystemFontOfSize:20.0];
    priceLab.text = [NSString stringWithFormat:@" ￥%.2f",[[self.goodsDetailDic objectForKey:@"goods_price"] floatValue] ];
    [titleView addSubview:priceLab];
    
    CGSize originalPriceLabSize = [[NSString stringWithFormat:@" ￥%.2f",[[self.goodsDetailDic objectForKey:@"marketPrice"] floatValue] * 2.0] sizeWithFont:[UIFont systemFontOfSize:13.0]
                                                                                                                                         constrainedToSize:CGSizeMake(120, 20)
                                                                                                                                             lineBreakMode:NSLineBreakByWordWrapping];
    
    UILabel *originalPriceLab = [[UILabel alloc] initWithFrame:CGRectMake(5 + detailPriceSize.width, layOutH + 8, originalPriceLabSize.width, 20)];
    originalPriceLab.backgroundColor = [UIColor clearColor];
    originalPriceLab.textColor = NAV_RED_COLOR;
    originalPriceLab.font = [UIFont systemFontOfSize:13.0];
    originalPriceLab.text = [NSString stringWithFormat:@" ￥%.2f",[[self.goodsDetailDic objectForKey:@"marketPrice"] floatValue]];
    [titleView addSubview:originalPriceLab];
    
    UIView *priceLine = [[UIView alloc] initWithFrame:CGRectMake(2, 10, originalPriceLabSize.width, 1)];
    priceLine.backgroundColor = NAV_RED_COLOR;
    [originalPriceLab addSubview:priceLine];
    layOutH += 35;
    
    UIView *line = [[UIView alloc] initWithFrame:CGRectMake(0, layOutH,SCREEN_WIDTH, 10)];
    line.backgroundColor = [UIColor colorWithRed:244/255.f green:244/255.f blue:244/255.f alpha:1.0];
    [titleView addSubview:line];
    layOutH +=line.height;
    
    // 包邮提示view
    [self initFreePostViewToView:titleView andFrame:CGRectMake(0, layOutH, SCREEN_WIDTH, QZMake(40))];
    layOutH += QZMake(40) ;
    
    line = [[UIView alloc] initWithFrame:CGRectMake(10, layOutH ,SCREEN_WIDTH, 0.5)];
    line.backgroundColor = GRAY_COLOR_TABLEVIEWLINE;
    [titleView addSubview:line];
    
    
    // 领取购物券
    [self initGetCouponViewToView:titleView andFrame:CGRectMake(0, layOutH, SCREEN_WIDTH, QZMake(40))];
    layOutH += QZMake(40);
    
    line = [[UIView alloc] initWithFrame:CGRectMake(0, layOutH,SCREEN_WIDTH, 10)];
    line.backgroundColor = [UIColor colorWithRed:244/255.f green:244/255.f blue:244/255.f alpha:1.0];
    [titleView addSubview:line];
    titleView.frame = CGRectMake(0, SCREEN_WIDTH +10,SCREEN_WIDTH, layOutH + 40);    
    layOutH += 10;
    
    
    [self initPicViewToView:titleView andFrame:CGRectMake(0, layOutH, SCREEN_WIDTH, QZMake(68))];
    layOutH +=QZMake(68);
    
    line = [[UIView alloc] initWithFrame:CGRectMake(0, layOutH,SCREEN_WIDTH, 10)];
    line.backgroundColor = [UIColor colorWithRed:244/255.f green:244/255.f blue:244/255.f alpha:1.0];
    [titleView addSubview:line];
    titleView.frame = CGRectMake(0, SCREEN_WIDTH +10,SCREEN_WIDTH, layOutH + 40);
    layOutH += 10;

    topViewH = layOutH;
    
    
    
    
    
    
}
//包邮提示
-(void)initFreePostViewToView:(UIView *)fatherView andFrame:(CGRect)frame
{
    UIView *view =[[UIView alloc] initWithFrame:frame];
    
    UIImageView *leftImage=[[UIImageView alloc] initWithImage:UIImageByName(@"goodDetailLogo_car")];
    leftImage.frame = CGRectMake(5, 0, QZMake(25), QZMake(25));
    leftImage.centerY=view.height/2.;
    [view addSubview:leftImage];
    
    UILabel *lab=[[UILabel alloc] initWithFrame:CGRectMake(leftImage.right+5, 0, SCREEN_WIDTH, view.height)];
    lab.font = FONT_WITH_SIZE(13);
    lab.textColor=UIColorFromRGB(0x616161);
    lab.text = [NSString stringWithFormat:@"在线支付满%@包邮，货到付款满%@包邮",alipayMinPriceStr,huoDaoMinPriceStr];
    [view addSubview:lab];
    
    [fatherView addSubview:view];

}

//领取优惠券
-(void)initGetCouponViewToView:(UIView *)fatherView andFrame:(CGRect)frame
{
    UIView *view =[[UIView alloc] initWithFrame:frame];
    
    UIImageView *leftImage=[[UIImageView alloc] initWithImage:UIImageByName(@"goodDetailLogo_coupons")];
    leftImage.frame = CGRectMake(5, 0, QZMake(25), QZMake(25));
    leftImage.centerY=view.height/2.;
    [view addSubview:leftImage];
    
    UILabel *lab=[[UILabel alloc] initWithFrame:CGRectMake(leftImage.right+5, 0, SCREEN_WIDTH, view.height)];
    lab.font = FONT_WITH_SIZE(13);
    lab.textColor=UIColorFromRGB(0x616161);
    lab.text = [NSString stringWithFormat:@"点击领取优惠券"];
    [view addSubview:lab];
    
    
    UIImageView *img = [[UIImageView alloc] initWithFrame:CGRectMake(SCREEN_WIDTH - 35, 15 ,14, 14)];
    [img setImage:[UIImage imageNamed:@"icon_arrows_nor.png"]];
    img.centerY = view.height/2.;
    [view addSubview:img];
    
    
    UIButton *btn =[UIButton buttonWithType:0];
    [btn setFrame:CGRectMake(0, 0, view.width, view.height)];
    [btn addTarget:self action:@selector(couponClick:) forControlEvents:UIControlEventTouchUpInside];
    [view addSubview:btn];
    
    view.userInteractionEnabled = YES;
    [fatherView addSubview:view];
    
    
}


//
-(void)initPicViewToView:(UIView *)fatherView andFrame:(CGRect)frame
{
    
   UIView *view =[[UIView alloc] initWithFrame:frame];
   [fatherView addSubview:view];

    NSArray *nameArr=@[@"货到付款",@"健康材质",@"私密配送",@"7天退货",@"正品保障",@"闪电配送"];
    for (int row=0; row<2; row++) {
        
        for (int column=0; column<3; column++) {
            
            UIButton *btn =[UIButton buttonWithType:0];
            [btn setFrame:CGRectMake(column * SCREEN_WIDTH/3., row * view.height/2., SCREEN_WIDTH/3. , view.height/2.)];
            UIImage *image=[UIImage imageNamed:[NSString stringWithFormat:@"goodDetailLogo_%d",row*3+column]];

            [btn setImage:image forState:UIControlStateNormal];
            [btn setTitle:nameArr[row*3 + column] forState:UIControlStateNormal];

            [btn setTitleColor:UIColorFromRGB(0xa5a5a5) forState:UIControlStateNormal];
            [btn.titleLabel setFont:fontWithSize(13)];
            [btn setImageEdgeInsets:UIEdgeInsetsMake(0, 10, 0, 0)];
            btn.contentHorizontalAlignment=UIControlContentHorizontalAlignmentLeft;
            [btn setTitleEdgeInsets:UIEdgeInsetsMake(0, 20, 0, 0)];
            [view addSubview:btn];
        }
    }
}





-(void)initRecommendView
{
    self.recommendView = [[SDGoodDetailRecommend alloc] initWithFrame:CGRectMake(0,SCREEN_WIDTH +10.+ topViewH, SCREEN_WIDTH, QZMake(140)+10) withArray:self.recommendArr isGroup:self.isRecommendGroup];
    self.recommendView.mainVC=self;
    [headView addSubview:self.recommendView];
//    topViewH +=self.recommendView.height;
    
    //重新布局
    [self formartFrame ];
    
}


// 评论View
-(void)initCommentView
{
    
    //FIXME: 要考虑 没有评论的情况
    
    if(self.goodsDetailDic && self.goodsDetailDic[@"firstComment"] && ![self.goodsDetailDic[@"firstComment"] isKindOfClass:[NSNull class]])
    {
        self.commentView = [[SDGoodCommentView alloc] initWithDic:self.goodsDetailDic];
        self.commentView.mainVC = self;
        self.commentView.goodsId = self.goodsIdStr;
        self.commentView.top =SCREEN_WIDTH +10. + topViewH;
        [headView addSubview:self.commentView];
//        topViewH +=self.commentView.height;
    }
    
    
}

#pragma mark  顶部商品大图scroll
-(void)initTopPicScrollView
{
    
    self.topPicScView = [[SDGoodDetailHeadView alloc] initWithFrameAndType:CGRectMake(0, 0,SCREEN_WIDTH, SCREEN_WIDTH) pvc:self];
    [headView addSubview:self.topPicScView];
    
}






#pragma mark  领取优惠券
-(void)couponClick:(id)sender
{
    CouponsViewController *vc =[[CouponsViewController alloc] init];
    
    [self.navigationController pushViewController:vc animated:YES];
}

#pragma mark 收藏商品  取消收藏
-(void)collectGoodsAction
{
    
    NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
    
    if ([defaults objectForKey:@"isLogin"]) {
        if (collectBtn.selected == YES) {// 取消收藏
            NSDictionary *params = [[NSDictionary alloc]init];
            params = @{@"deleteGoodAppId":[self.goodsDetailDic objectForKey:@"id"],@"deleteMemberAppId":[defaults objectForKey:@"userId"],@"imiestatus":@"1",@"imie":@""};
            
            NSLog(@"params-->%@",params);
            
            [self requestCancelCollectWithDic:params];
        }else//添加收藏
        {
            NSDictionary *params = [[NSDictionary alloc]init];
            params = @{@"goodAppId":[self.goodsDetailDic objectForKey:@"id"],@"memberAppId":[defaults objectForKey:@"userId"],@"imiestatus":@"1",@"imie":@""};
            
            NSLog(@"params-->%@",params);
            
            [self requestAddCollectWithDic:params];
        }
        
    }else
    {
        //未登录情况
        //        LoginViewController *ctrVC = [[LoginViewController alloc] initWithNibName:@"LoginViewController" bundle:[NSBundle mainBundle]];
        //        ctrVC.hidesBottomBarWhenPushed = YES;
        //        [self.navigationController pushViewController:ctrVC animated:YES];
        
        if (collectBtn.selected == YES) {// 取消收藏
            NSDictionary *params = [[NSDictionary alloc]init];
            params = @{@"deleteGoodAppId":[self.goodsDetailDic objectForKey:@"id"],@"deleteMemberAppId":@"",@"imiestatus":@"0",@"imie":DEVICEUUID};
            
            NSLog(@"params-->%@",params);
            
            [self requestCancelCollectWithDic:params];
        }else//添加收藏
        {
            NSDictionary *params = [[NSDictionary alloc]init];
            params = @{@"goodAppId":[self.goodsDetailDic objectForKey:@"id"],@"memberAppId":@"",@"imiestatus":@"0",@"imie":DEVICEUUID,@"channel":[NSString stringWithFormat:@"iOS%@",Flag]};
            
            NSLog(@"params-->%@",params);
            
            [self requestAddCollectWithDic:params];
        }
        
    }
    
    
}

#pragma mark- textField detegate

- (void)textFieldDidBeginEditing:(UITextField *)textField
{
    
    [self.goodColorChooseView.numChooseScrol setContentOffset:CGPointMake(0, self.goodColorChooseView.numChooseScrol.contentSize.height - 85) animated:YES];
}


#pragma mark 完成购买数量选择
-(void)goodsNumChoose:(id)sender
{
    [self.goodColorChooseView.goodsNumField resignFirstResponder];
    [self.goodColorChooseView.numChooseScrol setContentOffset:CGPointMake(0, 0)];
    if ([self.goodColorChooseView.goodsNumField.text intValue] >= 999) {
        self.goodColorChooseView.goodsNumField.text = @"999";
        self.promptLab.text = @"超出范围";
        [self showPromptLab];
    }else if ([self.goodColorChooseView.goodsNumField.text intValue] < 1)
    {
        self.goodColorChooseView.goodsNumField.text = @"1";
        self.promptLab.text = @"超出范围";
        [self showPromptLab];
    }
    
 
}

#pragma mark 增加商品数量
- (void)plusGoodsNumAction:(id)sender {
    
    if ([self.goodColorChooseView.goodsNumField.text intValue] < 999) {
        self.goodColorChooseView.goodsNumField.text = [NSString stringWithFormat:@"%d",[self.goodColorChooseView.goodsNumField.text intValue] + 1];
    }else
    {
        self.promptLab.text = @"超出范围";
        [self showPromptLab];
        
    }
    

    
}
#pragma mark 减少商品数量
- (void)minusGoodsNumAction:(id)sender {
    if ([self.goodColorChooseView.goodsNumField.text intValue] > 1) {
        self.goodColorChooseView.goodsNumField.text = [NSString stringWithFormat:@"%d",[self.goodColorChooseView.goodsNumField.text intValue] - 1];
        
    }else
    {
        self.promptLab.text = @"超出范围";
        [self showPromptLab];
    }
}
#pragma mark 确定购买 加入购物车

- (void)sureBuyAction:(NSInteger )numIndex {
    if (self.numIndexColor == 100) {
        self.promptLab.text = @"请选择规格";
        [self showPromptLab];
        
    }else
    {
        [self cancelBuyAction:nil];
        
        //防止偶尔出现bug
        if (!_colorArray || _colorArray.count==0) {
            return;
        }
        
        NSLog(@"--<>>%@",[_colorArray objectAtIndex:_numIndexColor]);
        
        NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
        //        if ([defaults objectForKey:@"isLogin"]) {
        NSDictionary *params = [[NSDictionary alloc]init];
        
        if (ISLOGIN) {
            params = @{@"userId":[defaults objectForKey:@"userId"],@"productId":[[_colorArray objectAtIndex:_numIndexColor] objectForKey:@"productId"],@"quantity":self.goodColorChooseView.goodsNumField.text};
        }else// 未登录
            params = @{@"userId":@"",@"productId":[[_colorArray objectAtIndex:_numIndexColor] objectForKey:@"productId"],@"quantity":self.goodColorChooseView.goodsNumField.text,@"imiestatus":@"0",@"imie":DEVICEUUID,@"channel":[NSString stringWithFormat:@"iOS%@",Flag]};
        
        
        [self requestAddGoodsToShopCarWithDic:params];
        
        
        // 统计购物车
        NSDictionary *dict = @{ @"quantity" :[NSString stringWithFormat:@"%@",self.goodColorChooseView.goodsNumField.text], @"total_price" : [NSString stringWithFormat:@"%.2f",[_colorArray[_numIndexColor][@"price"] floatValue]* [self.goodColorChooseView.goodsNumField.text intValue] ], @"channel" : [NSString stringWithFormat:@"iOS%@",Flag]};
        [MobClick event:@"Add_Cart" attributes:dict];
        NSLog(@"统计购物车=%@",dict);
        
        
        
        //加入购物车动画效果
        __block UIImageView *starView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 100, 60, 60)];
        [UIView animateWithDuration:0.6
                              delay:0.0
                            options:UIViewAnimationOptionCurveLinear
                         animations:^{
                             // grab the imageview using cell
                             UIImageView *imgV = [[UIImageView alloc] init];
                             
                             if (judgeUrlIsHave(self.goodsDetailDic, @"newThumbnailGoodsImagePath")) {
                                 [imgV sd_setImageWithURL:[NSURL URLWithString:[self.goodsDetailDic objectForKey:@"newThumbnailGoodsImagePath"]] placeholderImage:nil];
                             }else
                             {
                                 [imgV sd_setImageWithURL:[PublicMethod imgWithUrl:[self.goodsDetailDic objectForKey:@"ThumbnailGoodsImagePath"]] placeholderImage:nil];
                             }
                             
                             
                             
                             imgV.frame = CGRectMake(10, STAR_Y, 80, 80);
                             CGRect rect = [self.view convertRect:imgV.frame toView:self.view];
                             rect = CGRectMake(10,100, 60, 60);
                             NSLog(@"rect is %f,%f,%f,%f",rect.origin.x,rect.origin.y,rect.size.width,rect.size.height);
                             
                             // create new duplicate image
                             
                             starView = [[UIImageView alloc] initWithImage:imgV.image];
                             [starView setFrame:rect];
                             starView.layer.borderColor = [[UIColor lightGrayColor]CGColor];
                             starView.layer.borderWidth = 0.5;
                             [self.view addSubview:starView];
                             
                             
                             // begin ---- apply position animation
                             CAKeyframeAnimation *pathAnimation = [CAKeyframeAnimation animationWithKeyPath:@"position"];
                             pathAnimation.calculationMode = kCAAnimationPaced;
                             pathAnimation.fillMode = kCAFillModeForwards;
                             pathAnimation.removedOnCompletion = NO;
                             pathAnimation.duration=0.65;
                             pathAnimation.delegate=self;
                             
                             // tab-bar right side item frame-point = end point
                             CGPoint endPoint = CGPointMake(self.shopCarBtn.center.x, self.shopCarBtn.center.y + 20);
                             
                             CGMutablePathRef curvedPath = CGPathCreateMutable();
                             CGPathMoveToPoint(curvedPath, NULL, starView.frame.origin.x, starView.frame.origin.y);
                             CGPathAddCurveToPoint(curvedPath, NULL, starView.frame.origin.x, starView.frame.origin.y, endPoint.x, starView.frame.origin.y, endPoint.x, endPoint.y);
                             pathAnimation.path = curvedPath;
                             CGPathRelease(curvedPath);
                             // end ---- apply position animation
                             
                             // apply transform animation
                             CABasicAnimation *basic=[CABasicAnimation animationWithKeyPath:@"transform"];
                             [basic setToValue:[NSValue valueWithCATransform3D:CATransform3DMakeScale(0.15, 0.15, 0.15)]];
                             [basic setAutoreverses:NO];
                             [basic setDuration:0.65];
                             
                             [starView.layer addAnimation:pathAnimation forKey:@"curveAnimation"];
                             [starView.layer addAnimation:basic forKey:@"transform"];
                             
                         } completion:^(BOOL completion){
                             [starView removeFromSuperview];
                             //                         [self reloadBadgeNumber];
                         }];
        
        if (_goBuyNow) {
            _goBuyNow = NO;
            [self performSelector:@selector(toShopCarView:) withObject:self afterDelay:1.0];
        }
        
    }
}


#pragma mark 取消购买
- (void)cancelBuyAction:(id)sender {
    
    self.primaryView.userInteractionEnabled=YES;
    
    [UIView animateWithDuration:0.3 animations:^{
        CALayer *layer = self.primaryView.layer;
        layer.zPosition = -4000;
        CATransform3D rotationAndPerspectiveTransform = CATransform3DIdentity;
        rotationAndPerspectiveTransform.m34 = 1.0 / 300;
        layer.transform = CATransform3DRotate(rotationAndPerspectiveTransform, -10.0f * M_PI / 180.0f, 1.0f, 0.0f, 0.0f);
        
        self.primaryShadeView.alpha = 0.35;
    } completion:^(BOOL finished) {
        [UIView animateWithDuration:0.3 animations:^{
            self.primaryView.transform = CGAffineTransformMakeScale(1.0, 1.0);
            
            self.primaryShadeView.alpha = 0.0;
            
            self.goodColorChooseView.frame = CGRectMake(0, self.primaryView.frame.size.height, self.goodColorChooseView.frame.size.width, self.goodColorChooseView.frame.size.height);
        }];
    }];
    
    
    [self.goodColorChooseView.goodsNumField resignFirstResponder];
    [self.goodColorChooseView.numChooseScrol setContentOffset:CGPointMake(0, 0) animated:YES];
    
    
    
}

#pragma mark 返回
-(void)toBackView
{
    isBack=YES;
    [self.navigationController popViewControllerAnimated:YES];
}
#pragma mark -
#pragma mark 选择规格购买   点击购物车
- (void)toBuy:(id)sender {
    
    
    
    _goBuyNow = NO;
    self.goodColorChooseView.hidden = NO;
    
    
    self.primaryView.userInteractionEnabled=NO;
    
    [UIView animateWithDuration:0.3 animations:^{
        self.goodColorChooseView.frame = CGRectMake(0, self.primaryView.frame.size.height - self.goodColorChooseView.frame.size.height, self.goodColorChooseView.frame.size.width, self.goodColorChooseView.frame.size.height);
        
        CALayer *layer = self.primaryView.layer;
        layer.zPosition = -4000;
        CATransform3D rotationAndPerspectiveTransform = CATransform3DIdentity;
        rotationAndPerspectiveTransform.m34 = 1.0 / -300;
        layer.transform = CATransform3DRotate(rotationAndPerspectiveTransform, 10.0f * M_PI / 180.0f, 1.0f, 0.0f, 0.0f);
        
        self.primaryShadeView.alpha = 0.35;
    } completion:^(BOOL finished) {
        [UIView animateWithDuration:0.3 animations:^{
            self.primaryView.transform = CGAffineTransformMakeScale(0.9, 0.9);
            
            self.primaryShadeView.alpha = 0.5;
        }];
    }];
    _goBuyNow = NO;
    

}

#pragma mark 显示提示
-(void)showPromptLab
{
    [UIView animateWithDuration:1.0 delay:0.0 options:UIViewAnimationOptionCurveEaseIn animations:^{self.promptLab.alpha = 0.5;} completion:nil];
    [self performSelector:@selector(dismissPromptLab) withObject:nil afterDelay:1.0];
}
#pragma mark 提示消失
-(void)dismissPromptLab
{
    [UIView animateWithDuration:1.0 delay:1.0 options:UIViewAnimationOptionCurveEaseIn animations:^{self.promptLab.alpha = 0.0;} completion:nil];
}


#pragma mark 右上角跳转购物车页面
- (void)toShopCarView:(id)sender {
    
    ShopCarController *controller = [[ShopCarController alloc] initWithNibName:@"ShopCarController" bundle:[NSBundle mainBundle]];
    controller.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:controller animated:YES];
    
    
}

#pragma mark 联系客服

- (void)toContactAction:(id)sender {
    
    UIWebView*callWebview =[[UIWebView alloc] init];
    NSURL *telURL =[NSURL URLWithString:@"tel:4000003879"];
    [callWebview loadRequest:[NSURLRequest requestWithURL:telURL]];
    //记得添加到view上
    [self.view addSubview:callWebview];
    
}

#pragma mark 立即购买  跳转订单页面
//- (IBAction)toBuyNowAction:(id)sender {
- (void)toBuyNowAction:(id)sender {
    
    
    [self toBuy:nil];
    _goBuyNow = YES;
    
}

#pragma mark -  MKHttpRequestAction 商品详情====================
-(void)requestGoodsDetailWithDic:(NSDictionary *)dic
{
    
    self.indicator.hidden = NO;
    
    [self.indicator startAnimating];
    
    
    
   opration= [[MKHttpServiceEngine shareMyInstance] requestGoodsDetailWithDic:dic completionHandler:^(id responseObject) {
        NSDictionary *detaiDic = responseObject;
        NSLog(@"商品详情detaiDic-->%@",detaiDic);
        
        self.indicator.hidden = YES;
        
        if ([[detaiDic objectForKey:@"success"] boolValue]== 1) {
            
            NSMutableDictionary *dataSourceDic=[[detaiDic objectForKey:@"datasource"] firstObject];
            
            self.goodsDetailDic = dataSourceDic;
            self.classifyIdStr = [dataSourceDic objectForKey:@"goodsCategoryId"];
            
            [self initDetailScrollView];//初始化总的ScrollView
            [self initColorChooseView];//商品规格选择view 设置图片 价格 名称
            
            
            // 下载相关推荐
            NSDictionary *params = [[NSDictionary alloc]init];
            
            if ([dataSourceDic[@"hasPackages"] intValue]==2) {//是否有套餐商品(2、有，3、推荐)
                
                params = @{@"pageSizeApp":@"9",
                           @"pageApp":@"1",
                           @"categoryId":self.classifyIdStr,
                           @"sorting":@"desc",
                           @"goodsId":dataSourceDic[@"id"]
                           };
                self.isRecommendGroup = YES;
                
            }else
            {
                params = @{@"pageSizeApp":@"9",@"pageApp":@"1",@"categoryId":self.classifyIdStr,@"sorting":@"desc"};
                self.isRecommendGroup = NO;
            }
            
            [self requestSortClassifyGoodsListWithDic:params withSortPath:@"goods!getGoodsAppByCompre.action"];

            
            //判断该商品是否收藏
            NSLog(@"--》%@..%@",[[AppSet shareInstance] collectArray],[self.goodsDetailDic objectForKey:@"id"]);
            if ([[[AppSet shareInstance] collectArray] containsObject:[self.goodsDetailDic objectForKey:@"id"]]) {
                collectBtn.selected = YES;
            }else
            {
                collectBtn.selected = NO;
            }
            
            
            //详情top广告图
            if (![[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"imagePath"] isKindOfClass:[NSNull class]]) {
                if ([[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"imagePath"] count] > 0) {
                    [self.imagesArray removeAllObjects];
                    
                    NSArray *imgArray = [[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"imagePath"];
                    
                    for (NSDictionary *dic in imgArray) {
                        
                        // gdFlag 当改图片不符合标准 或者被用到其他地方的时候 会标志为1 该处不显示
                        if ([[dic objectForKey:@"gdFlag"] boolValue] == 0) {
                                // path 换newPath
                            NSString *imgStr = nil;
                            if(judgeUrlIsHave(dic, @"newPath"))
                            {
                                imgStr = [NSString stringWithFormat:@"%@",[dic objectForKey:@"newPath"]];
                            }else
                            {
                                imgStr = [NSString stringWithFormat:@"%@/big/%@.%@",[dic objectForKey:@"path"],[dic objectForKey:@"id"],[dic objectForKey:@"sourceImageFormatName"]];
                                
                                imgStr=[PublicMethod imgStrWithUrl:imgStr];
                            }
                            
                            
                            [_imagesArray addObject:imgStr];
                        
                        }
                    }
                    [self.topPicScView setUpImageUrlList:_imagesArray];
                }
                
            }
            
            
            //*
            //规格选择
            if ([[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"IsSpecificationEnabled"] boolValue] == 1) {
                isSpecification = YES;
                
                if (![[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"productDetail"] isKindOfClass:[NSNull class]]) {
                    [_colorArray removeAllObjects];
                    [_colorArray addObjectsFromArray:[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"productDetail"]];
                }
                
                
                _numIndexColor = 100;//默认100 没选择商品
                
                [self setupGridView];
                
            }else
            {
                if (![[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"productDetail"] isKindOfClass:[NSNull class]]) {
                    [_colorArray removeAllObjects];
                    
                    NSMutableDictionary *dic = [NSMutableDictionary dictionaryWithDictionary:[[[[detaiDic objectForKey:@"datasource"] firstObject]objectForKey:@"productDetail"] firstObject]];
                    [dic setValue:@"标准规格" forKey:@"Specifications"];
                    
                    [_colorArray addObject:dic];
                    
                    
                    _numIndexColor = 0;// 标准规格 默认选中第一个
                    
                    [self setupGridView];
                }
            }
            
            
//            */
            
        }
        
        
        
        
    } errorHandler:^(NSError *error) {
        NSLog(@"error-->%@",error);
        self.indicator.hidden = YES;
        
        self.promptLab.text = @"请检查网络设置!";
        [self showPromptLab];
        
        
    }];
}


#pragma mark 加入收藏

-(void)requestAddCollectWithDic:(NSDictionary *)dic
{
    
    
    
    [[MKHttpServiceEngine shareMyInstance] requestAddCollectWithDic:dic completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        NSLog(@"responseArray-->%@",responseDic);
        
        NSLog(@".-->%@",[self.goodsDetailDic objectForKey:@"id"]);
        
        NSMutableArray *arry = [NSMutableArray arrayWithArray:[[AppSet shareInstance] collectArray]];
        [arry addObject:[self.goodsDetailDic objectForKey:@"id"]];
        [[AppSet shareInstance] setCollectArray:arry];
        [[AppSet shareInstance] saveCollectGoodsData];
        
        self.promptLab.text = [responseDic objectForKey:@"message"];
        [self showPromptLab];
        
        collectBtn.selected = YES;
        
    } errorHandler:^(NSError *error) {
        NSLog(@"error-->%@",error);
        self.promptLab.text = @"请检查网络设置!";
        [self showPromptLab];
        
    }];
}

#pragma mark 删除收藏
-(void)requestCancelCollectWithDic:(NSDictionary *)dic
{
    
    [[MKHttpServiceEngine shareMyInstance] requestCancelCollectWithDic:dic completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        NSLog(@"responseArray-->%@",responseDic);
        
        
        NSMutableArray *arry = [NSMutableArray arrayWithArray:[[AppSet shareInstance] collectArray]];
        [arry removeObject:[self.goodsDetailDic objectForKey:@"id"]];
        [[AppSet shareInstance] setCollectArray:arry];
        [[AppSet shareInstance] saveCollectGoodsData];
        
        self.promptLab.text = [responseDic objectForKey:@"message"];
        [self showPromptLab];
        
        collectBtn.selected = NO;
        
    } errorHandler:^(NSError *error) {
        NSLog(@"error-->%@",error);
        self.promptLab.text = @"请检查网络设置!";
        [self showPromptLab];
        
        
    }];
}


#pragma mark 加入购物车
-(void)requestAddGoodsToShopCarWithDic:(NSDictionary *)dic
{
    
    [[MKHttpServiceEngine shareMyInstance] requestAddGoodsToShopCarWithDic:dic completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        NSLog(@"responseArray-->%@",responseDic);
        
        self.promptLab.text = [responseDic objectForKey:@"message"];
        [self showPromptLab];
        
        [self requestShopCarList];
        
    } errorHandler:^(NSError *error) {
        NSLog(@"error-->%@",error);
        
        self.promptLab.text = @"请检查网络设置!";
        [self showPromptLab];
        
    }];
}


#pragma mark MKHttpRequestAction  SortGoodsList 相关推荐
-(void)requestSortClassifyGoodsListWithDic:(NSDictionary *)dic  withSortPath:(NSString *)sortStr
{
    
    
    oprationTuiJian=[[MKHttpServiceEngine shareMyInstance] requestSortGoodsListWithDic:dic withSortPath:sortStr completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        
        if ([[responseDic objectForKey:@"success"] boolValue] == 1) {
            
            if ([[responseDic objectForKey:@"datasource"] count] > 0 ) {
                [_recommendArray removeAllObjects];
                
                [_recommendArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
                
                NSLog(@"推荐arry-->%@",_recommendArray);
                
                
                self.recommendArr = [[NSMutableArray alloc] init];
                NSArray *tempArray = responseDic[DATASOURCE];
                int index = 0;
                while (index<tempArray.count) {
                    
                    SDGoodRecommendObj *model=[[SDGoodRecommendObj alloc] initWithDict:tempArray[index]];
                    [self.recommendArr addObject:model];
                    
                    index ++;
                }
                
                if (self.recommendArr.count >0) {
                    [self initRecommendView];
                }
            }
            
            
        }else
        {
            self.promptLab.text = [responseDic objectForKey:@"message"];
            [self showPromptLab];
            
        }
        
        
        
    } errorHandler:^(NSError *error) {
        
        NSLog(@"error-->%@",error);
        
    }];
    
}



#pragma ShopCarRequest  购物车

-(void)requestShopCarList
{
    NSDictionary *params = [[NSDictionary alloc]init];
    if (ISLOGIN) {
        params = @{@"userId":USERID,@"pageApp":@"1",@"pageSizeApp":@"100"};
    }else
        params = @{@"userId":@"",@"pageApp":@"1",@"pageSizeApp":@"100",@"imiestatus":@"0",@"imie":DEVICEUUID};

    
    [[MKHttpServiceEngine shareMyInstance] requestShopCarListWithDic:params completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        NSLog(@"购物车-->%@",responseDic);

        if ([[responseDic objectForKey:@"success"] boolValue]) {
            
            
            self.numLabel.text = [NSString stringWithFormat:@"%d",(int)[[responseDic objectForKey:@"datasource"] count]];
            
            [[ShopCarObj shareInstance] setShopCarDataArray:[responseDic objectForKey:@"datasource"]];
            
            
            NSDictionary *dic=@{@"messageNum":[NSString stringWithFormat:@"%@",self.numLabel.text]};
            [[NSNotificationCenter defaultCenter] postNotificationName:NOTIFICATION_SHOPCARMESSAGE object:nil userInfo:dic];
        }else
        {
            
            
        }
        
        
        
        
    } errorHandler:^(NSError *error) {
        
        
    }];
}


#pragma mark - 商品图文详情 布局及请求
-(void)initDetailPicView
{
    if(self.productDetailView==nil)
    {
        self.productDetailView =[[UIView alloc] initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_WIDTH)];
        
        [self.detailScrollView addSubview:self.productDetailView];
    }
    
    NSDictionary *params = [[NSDictionary alloc]init];
    params = @{@"goodId":self.goodsIdStr};
   
    oprationTuWen=[[MKHttpServiceEngine shareMyInstance] requestIntroductionimgWithDic:params completionHandler:^(id responseObject) {
        
        NSDictionary *responseDic = responseObject;
        NSLog(@"商品图文详情 detaiDic-->%@",responseDic);
        
        if (responseDic[@"datasource"] && [responseDic[@"datasource"] isKindOfClass:[NSArray class]] && [responseDic[@"datasource"] count]>0) {
            [self.detailImageStrArray removeAllObjects];
            
            if(responseDic[@"totaldatasource"] && ![responseDic[@"totaldatasource"] isKindOfClass:[NSNull class]]&& [responseDic[@"totaldatasource"] count]>0)
            {
                [self.detailImageStrArray addObjectsFromArray:responseDic[@"totaldatasource"]];
            }else
            {
                 [self.detailImageStrArray addObjectsFromArray:responseDic[@"datasource"]];
                
                for (int i=0; i<self.detailImageStrArray.count; i++) {
                    NSString *str=[PublicMethod imgStrWithShopXXUrl:self.detailImageStrArray[i]];
                    
                    [self.detailImageStrArray replaceObjectAtIndex:i withObject:str];
                }
                
                
            }
            
        }
        
        float begin_y=0;
        for (int i=0; i<self.detailImageStrArray.count; i++) {
            QzImageView *imageView=[[QzImageView alloc] initWithFrame:CGRectMake(0, begin_y, SCREEN_WIDTH, SCREEN_WIDTH)];
            imageView.tag=1000+i;
            imageView.backgroundColor=GRAY_COLOR_BG;
            [self.productDetailView addSubview:imageView];
            begin_y +=SCREEN_WIDTH;
        }
        
        [self downImageWithIndex:0];
        
    } errorHandler:^(NSError *error) {
        
    }];
    
}

-(void)downImageWithIndex:(int)index
{
    if (isBack) {
        return;
    }
    QzImageView *imageView=(QzImageView *)[self.productDetailView viewWithTag:1000+index];
    
    if(self.detailImageStrArray.count<=index)
        return;
    
    NSURL *imageurl=[NSURL URLWithString:self.detailImageStrArray[index]];
    
    [imageView qzSetImageWithURL:imageurl placeholderImage:nil completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, NSURL *imageURL) {
        
        // 调整位置 并下载下一张图片
        [self downImageOverToFomartLabImageFrameWithIndex:index];
        
        
    }];
    
    
}

//图文混排的
-(void)downImageOverToFomartLabImageFrameWithIndex:(int)index
{
    if (isBack) {
        return;
    }
    CGFloat begin_y=0;
    
    for (int i=0; i<self.detailImageStrArray.count; i++) {
        
        QzImageView *imageView=(QzImageView *)[self.productDetailView viewWithTag:1000+i];
        
        if(index>i)//下载图片 前面的图片
        {
            begin_y =CGRectGetMaxY(imageView.frame)+0;
            
        }else if(index == i)//刚下载好的图片
        {
            CGSize imageSize=imageView.image.size;
            
            NSLog(@"imageSize %@  ",NSStringFromCGSize(imageSize));
            CGFloat imageHeight=imageSize.width==0 ? 0 : imageSize.height*SCREEN_WIDTH/imageSize.width;
            
            
            imageView.frame=CGRectMake(0, begin_y, SCREEN_WIDTH,imageHeight );
            
            
            begin_y +=imageHeight +0;
            
            
        }else // 该图片在下载好的图片的下面
        {
            CGRect frame=imageView.frame;
            frame.origin.y=begin_y;
            imageView.frame=frame;
            
            begin_y =CGRectGetMaxY(imageView.frame)+0;
        }
        
    }
    
    //调整headView的高度 和白线的位置
    self.productDetailView.frame=CGRectMake(0, 0, SCREEN_WIDTH, begin_y+5);
    
    if(segmentIndex == 0)
    {
        
        [self formartFrame ];
    }

    
    
    if (index+1<self.detailImageStrArray.count) {
        //顺序下载 下一张图片
        [self downImageWithIndex:index+1];
    }
    
    
    
}


///*
#pragma mark MKHttpRequestAction  GoodsList

#pragma mark 评论
-(void)requestCommentListWithDic:(NSDictionary *)dic
{
    self.indicator.hidden = NO;
    [_indicator setCenter:CGPointMake(SCREEN_WIDTH/2., SCREEN_HEIGHT/2.)];
    [self.indicator startAnimating];
    
    
    oprationPingLun=[[MKHttpServiceEngine shareMyInstance] requestCommentListWithDic:dic completionHandler:^(id responseObject) {
        NSDictionary *responseDic = responseObject;
        
        NSLog(@"arry-->%@",responseDic);
        
        if ([[responseDic objectForKey:@"success"] boolValue] == 1) {
            
            [self.commentArray removeAllObjects];
            [self.commentArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
            
            
            [self isDowmloadMore:[responseDic objectForKey:@"datasource"]];
            
        }else
        {
            
        }
        
        [self.indicator stopAnimating];
        self.indicator.hidden = YES;
        
    } errorHandler:^(NSError *error) {
        
        NSLog(@"error-->%@",error);
        [self.indicator stopAnimating];
        self.indicator.hidden = YES;
        
    }];
}



#pragma mark 更多评论
-(void)getMoreData
{
    currentPage ++;
    
    NSDictionary *params = [[NSDictionary alloc]init];
    
    params = @{@"pageApp":[NSString stringWithFormat:@"%d",currentPage],@"pageSizeApp":@"20",@"commentGoodId":self.goodsIdStr};
    [self requestCommentListMoreWithDic:params];
}


-(void)requestCommentListMoreWithDic:(NSDictionary *)dic
{
    
    oprationPingLun=[[MKHttpServiceEngine shareMyInstance] requestCommentListWithDic:dic completionHandler:^(id responseObject) {
        
        NSDictionary *responseDic = responseObject;
        NSLog(@"更多评论arrys-->%@",responseDic);
        
        if ([[responseDic objectForKey:@"success"] boolValue] == 1) {
            if ([self.commentArray containsObject:[[responseDic objectForKey:@"datasource"] firstObject]]) {
                //                [goodsDataArray removeObjectsInArray:[responseDic objectForKey:@"datasource"]];
                //                [goodsDataArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
            }else
            {
                [self.commentArray addObjectsFromArray:[responseDic objectForKey:@"datasource"]];
            }
        }
        
        
        [self isDowmloadMore:[responseDic objectForKey:@"datasource"]];
        
        
        
    } errorHandler:^(NSError *error) {
        
        NSLog(@"error-->%@",error);
        
        currentPage --;
        
    }];
    
}
-(void)isDowmloadMore:(NSArray *)arry
{
    if ([arry count] > 19) {
        isHaveNextPage = YES;
    }else
    {
        isHaveNextPage = NO;
    }
    
}



//*/
- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end

